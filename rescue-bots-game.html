<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rescue Bots Academy - Transform and Learn!</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@500;700&display=swap');
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Rajdhani', sans-serif;
            background: linear-gradient(180deg, #0a0a0a 0%, #1a1a2e 50%, #0d1b2a 100%);
            min-height: 100vh;
            overflow-x: hidden;
            color: white;
        }
        .cyber-grid {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background-image: linear-gradient(rgba(0, 195, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 195, 255, 0.03) 1px, transparent 1px);
            background-size: 50px 50px;
            pointer-events: none;
            z-index: 0;
        }
        .energon-particle {
            position: fixed;
            width: 4px; height: 4px;
            background: #00d4ff;
            border-radius: 50%;
            box-shadow: 0 0 10px #00d4ff, 0 0 20px #00d4ff;
            animation: floatUp 8s linear infinite;
            pointer-events: none;
        }
        @keyframes floatUp {
            0% { transform: translateY(100vh) scale(0); opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { transform: translateY(-100vh) scale(1); opacity: 0; }
        }
        .container {
            position: relative;
            z-index: 1;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        header {
            text-align: center;
            padding: 30px;
            margin-bottom: 20px;
        }
        .autobot-logo {
            width: 80px; height: 80px;
            margin: 0 auto 15px;
        }
        .autobot-logo svg {
            width: 100%; height: 100%;
            filter: drop-shadow(0 0 15px #ff3333) drop-shadow(0 0 30px #ff3333);
        }
        h1 {
            font-family: 'Orbitron', sans-serif;
            font-size: 2.8em;
            font-weight: 900;
            background: linear-gradient(180deg, #ff4444 0%, #cc0000 50%, #ff6666 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: 4px;
            text-transform: uppercase;
            animation: energyPulse 2s infinite;
        }
        @keyframes energyPulse {
            0%, 100% { filter: drop-shadow(0 0 10px rgba(255, 0, 0, 0.5)); }
            50% { filter: drop-shadow(0 0 20px rgba(255, 0, 0, 0.8)); }
        }
        .subtitle {
            font-family: 'Orbitron', sans-serif;
            color: #00d4ff;
            font-size: 1.3em;
            margin-top: 10px;
            letter-spacing: 8px;
            text-transform: uppercase;
            text-shadow: 0 0 10px #00d4ff;
        }
        .tagline {
            color: #ffd700;
            font-size: 1.4em;
            margin-top: 15px;
            font-weight: bold;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
            animation: taglinePulse 3s infinite;
        }
        @keyframes taglinePulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        .score-display {
            position: fixed;
            top: 20px; right: 20px;
            background: linear-gradient(135deg, #1a1a2e 0%, #0d1b2a 100%);
            border: 3px solid #00d4ff;
            padding: 15px 25px;
            clip-path: polygon(10px 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%, 0 10px);
            font-family: 'Orbitron', sans-serif;
            font-size: 1.3em;
            font-weight: bold;
            color: #00d4ff;
            box-shadow: 0 0 20px rgba(0, 212, 255, 0.3);
            z-index: 100;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .score-display:hover {
            transform: scale(1.05);
        }
        .energon-icon {
            display: inline-block;
            width: 20px; height: 20px;
            background: linear-gradient(135deg, #00ffff, #0088ff);
            clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%);
            margin-right: 10px;
            animation: energonGlow 1s infinite;
            vertical-align: middle;
        }
        @keyframes energonGlow {
            0%, 100% { box-shadow: 0 0 5px #00d4ff; }
            50% { box-shadow: 0 0 15px #00d4ff, 0 0 25px #00d4ff; }
        }
        .shop-hint {
            font-size: 0.6em;
            display: block;
            color: #ffd700;
            margin-top: 5px;
        }
        .section-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.5em;
            color: #ffd700;
            text-align: center;
            margin: 30px 0 20px;
            text-transform: uppercase;
            letter-spacing: 3px;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }
        .section-title.locked-section {
            color: #888;
            text-shadow: none;
        }
        .main-menu {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            padding: 20px;
        }
        .menu-card {
            background: linear-gradient(145deg, #1a1a2e, #0d1b2a);
            border-radius: 5px;
            padding: 25px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            clip-path: polygon(0 10px, 10px 0, calc(100% - 10px) 0, 100% 10px, 100% calc(100% - 10px), calc(100% - 10px) 100%, 10px 100%, 0 calc(100% - 10px));
        }
        .menu-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            border: 3px solid;
            clip-path: polygon(0 10px, 10px 0, calc(100% - 10px) 0, 100% 10px, 100% calc(100% - 10px), calc(100% - 10px) 100%, 10px 100%, 0 calc(100% - 10px));
            pointer-events: none;
        }
        .menu-card:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }
        .menu-card.locked { filter: grayscale(0.5); }
        .menu-card.locked:hover { filter: grayscale(0.3); }
        .lock-overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10;
            clip-path: polygon(0 10px, 10px 0, calc(100% - 10px) 0, 100% 10px, 100% calc(100% - 10px), calc(100% - 10px) 100%, 10px 100%, 0 calc(100% - 10px));
        }
        .lock-icon {
            font-size: 50px;
            margin-bottom: 10px;
            animation: lockPulse 2s infinite;
        }
        @keyframes lockPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        .lock-price {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.2em;
            color: #00d4ff;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .lock-price .energon-icon { width: 16px; height: 16px; }
        .unlock-btn {
            margin-top: 15px;
            padding: 10px 25px;
            font-family: 'Orbitron', sans-serif;
            font-size: 1em;
            background: linear-gradient(135deg, #ffd700, #ffaa00);
            border: none;
            color: #000;
            cursor: pointer;
            clip-path: polygon(8px 0, calc(100% - 8px) 0, 100% 8px, 100% calc(100% - 8px), calc(100% - 8px) 100%, 8px 100%, 0 calc(100% - 8px), 0 8px);
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 2px;
        }
        .unlock-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
        }
        .unlock-btn:disabled {
            background: linear-gradient(135deg, #555, #333);
            color: #888;
            cursor: not-allowed;
        }
        .menu-card.heatwave::before { border-color: #ff3333; }
        .menu-card.heatwave { background: linear-gradient(145deg, #2a0a0a, #1a0505); }
        .menu-card.heatwave:hover { box-shadow: 0 0 30px rgba(255, 51, 51, 0.4); }
        .menu-card.heatwave .bot-color { color: #ff3333; text-shadow: 0 0 10px #ff3333; }
        .menu-card.blades::before { border-color: #ff8c00; }
        .menu-card.blades { background: linear-gradient(145deg, #2a1a0a, #1a0f05); }
        .menu-card.blades:hover { box-shadow: 0 0 30px rgba(255, 140, 0, 0.4); }
        .menu-card.blades .bot-color { color: #ff8c00; text-shadow: 0 0 10px #ff8c00; }
        .menu-card.chase::before { border-color: #0088ff; }
        .menu-card.chase { background: linear-gradient(145deg, #0a1a2a, #051015); }
        .menu-card.chase:hover { box-shadow: 0 0 30px rgba(0, 136, 255, 0.4); }
        .menu-card.chase .bot-color { color: #0088ff; text-shadow: 0 0 10px #0088ff; }
        .menu-card.boulder::before { border-color: #33cc33; }
        .menu-card.boulder { background: linear-gradient(145deg, #0a2a0a, #051a05); }
        .menu-card.boulder:hover { box-shadow: 0 0 30px rgba(51, 204, 51, 0.4); }
        .menu-card.boulder .bot-color { color: #33cc33; text-shadow: 0 0 10px #33cc33; }
        .menu-card.bumblebee::before { border-color: #ffd700; }
        .menu-card.bumblebee { background: linear-gradient(145deg, #2a2a0a, #1a1a05); }
        .menu-card.bumblebee:hover { box-shadow: 0 0 30px rgba(255, 215, 0, 0.4); }
        .menu-card.bumblebee .bot-color { color: #ffd700; text-shadow: 0 0 10px #ffd700; }
        .menu-card.optimus::before { border-color: #ff0000; }
        .menu-card.optimus { background: linear-gradient(145deg, #1a0a2a, #0a0515); }
        .menu-card.optimus:hover { box-shadow: 0 0 30px rgba(255, 0, 0, 0.4), 0 0 30px rgba(0, 100, 255, 0.4); }
        .menu-card.optimus .bot-color {
            background: linear-gradient(90deg, #ff0000, #0066ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .bot-icon {
            font-size: 70px;
            margin-bottom: 10px;
            display: block;
            filter: drop-shadow(0 5px 15px rgba(0,0,0,0.5));
        }
        /* Yellow car for Bumblebee */
        .yellow-car {
            display: inline-block;
            font-size: 70px;
            position: relative;
        }
        .yellow-car::before {
            content: 'üöó';
            filter: hue-rotate(40deg) saturate(2) brightness(1.1);
        }
        .menu-card h2 {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.4em;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }
        .menu-card .mission-type {
            color: #888;
            font-size: 1em;
            text-transform: uppercase;
            letter-spacing: 3px;
            margin-bottom: 10px;
        }
        .menu-card p.description {
            color: rgba(255,255,255,0.7);
            font-size: 1.1em;
        }
        .status-ready {
            display: inline-block;
            background: #33cc33;
            color: #000;
            padding: 3px 10px;
            font-size: 0.8em;
            font-family: 'Orbitron', sans-serif;
            margin-top: 10px;
            clip-path: polygon(5px 0, 100% 0, calc(100% - 5px) 100%, 0 100%);
            animation: statusBlink 2s infinite;
        }
        @keyframes statusBlink {
            0%, 90%, 100% { opacity: 1; }
            95% { opacity: 0.5; }
        }
        /* Transformation Animation Overlay */
        .transform-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle, #1a1a2e 0%, #000 100%);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 5000;
            flex-direction: column;
        }
        .transform-overlay.active { display: flex; }
        .transform-stage {
            position: relative;
            width: 300px;
            height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .vehicle-form, .robot-form {
            position: absolute;
            font-size: 150px;
            transition: all 0.5s ease;
        }
        .vehicle-form {
            opacity: 1;
            transform: scale(1) rotate(0deg);
        }
        .vehicle-form.transforming {
            animation: vehicleTransform 1.5s ease forwards;
        }
        @keyframes vehicleTransform {
            0% { opacity: 1; transform: scale(1) rotate(0deg); }
            30% { opacity: 1; transform: scale(1.2) rotate(10deg); }
            50% { opacity: 0; transform: scale(0.5) rotate(180deg); }
            100% { opacity: 0; transform: scale(0) rotate(360deg); }
        }
        .robot-form {
            opacity: 0;
            transform: scale(0) rotate(-180deg);
        }
        .robot-form.transforming {
            animation: robotAppear 1.5s ease forwards;
            animation-delay: 0.5s;
        }
        @keyframes robotAppear {
            0% { opacity: 0; transform: scale(0) rotate(-180deg); }
            50% { opacity: 1; transform: scale(1.3) rotate(10deg); }
            70% { transform: scale(0.9) rotate(-5deg); }
            100% { opacity: 1; transform: scale(1) rotate(0deg); }
        }
        .transform-sparks {
            position: absolute;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        .spark {
            position: absolute;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            top: 50%;
            left: 50%;
        }
        .spark.transforming {
            animation: sparkFly 1s ease-out forwards;
        }
        @keyframes sparkFly {
            0% { transform: translate(-50%, -50%) scale(0); opacity: 1; }
            100% { transform: translate(var(--tx), var(--ty)) scale(0); opacity: 0; }
        }
        .transform-text-overlay {
            font-family: 'Orbitron', sans-serif;
            font-size: 2.5em;
            color: #ffd700;
            text-shadow: 0 0 30px #ffd700, 0 0 60px #ffd700;
            margin-top: 30px;
            text-transform: uppercase;
            letter-spacing: 10px;
            opacity: 0;
        }
        .transform-text-overlay.show {
            animation: textFlash 2s ease forwards;
        }
        @keyframes textFlash {
            0% { opacity: 0; transform: scale(0.5); }
            30% { opacity: 1; transform: scale(1.1); }
            50% { opacity: 1; transform: scale(1); }
            100% { opacity: 0; transform: scale(1.5); }
        }
        .bot-name-transform {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.8em;
            margin-top: 20px;
            text-transform: uppercase;
            letter-spacing: 5px;
            opacity: 0;
        }
        .bot-name-transform.show {
            animation: nameAppear 1.5s ease forwards;
            animation-delay: 0.8s;
        }
        @keyframes nameAppear {
            0% { opacity: 0; transform: translateY(20px); }
            100% { opacity: 1; transform: translateY(0); }
        }
        /* Game Screen Styles */
        .game-screen {
            display: none;
            background: linear-gradient(145deg, #1a1a2e, #0d1b2a);
            border: 3px solid #00d4ff;
            padding: 30px;
            margin: 20px;
            clip-path: polygon(0 15px, 15px 0, calc(100% - 15px) 0, 100% 15px, 100% calc(100% - 15px), calc(100% - 15px) 100%, 15px 100%, 0 calc(100% - 15px));
            box-shadow: 0 0 30px rgba(0, 212, 255, 0.2);
        }
        .game-screen.active {
            display: block;
            animation: screenActivate 0.5s ease;
        }
        @keyframes screenActivate {
            0% { opacity: 0; transform: scale(0.95); }
            100% { opacity: 1; transform: scale(1); }
        }
        .back-btn {
            background: linear-gradient(135deg, #333, #1a1a1a);
            color: #00d4ff;
            border: 2px solid #00d4ff;
            padding: 12px 25px;
            font-family: 'Orbitron', sans-serif;
            font-size: 1em;
            cursor: pointer;
            margin-bottom: 20px;
            transition: all 0.3s ease;
            clip-path: polygon(10px 0, 100% 0, calc(100% - 10px) 100%, 0 100%);
            text-transform: uppercase;
            letter-spacing: 2px;
        }
        .back-btn:hover {
            background: #00d4ff;
            color: #000;
        }
        .game-header {
            text-align: center;
            margin-bottom: 25px;
        }
        .game-header h2 {
            font-family: 'Orbitron', sans-serif;
            font-size: 2em;
            text-transform: uppercase;
            letter-spacing: 3px;
        }
        .game-header.heatwave h2 { color: #ff3333; text-shadow: 0 0 20px rgba(255, 51, 51, 0.5); }
        .game-header.blades h2 { color: #ff8c00; text-shadow: 0 0 20px rgba(255, 140, 0, 0.5); }
        .game-header.chase h2 { color: #0088ff; text-shadow: 0 0 20px rgba(0, 136, 255, 0.5); }
        .game-header.boulder h2 { color: #33cc33; text-shadow: 0 0 20px rgba(51, 204, 51, 0.5); }
        .game-header.bumblebee h2 { color: #ffd700; text-shadow: 0 0 20px rgba(255, 215, 0, 0.5); }
        .game-header.optimus h2 {
            background: linear-gradient(90deg, #ff0000, #0066ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .bot-helper {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
            padding: 20px;
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.1);
            clip-path: polygon(10px 0, calc(100% - 10px) 0, 100% 10px, 100% calc(100% - 10px), calc(100% - 10px) 100%, 10px 100%, 0 calc(100% - 10px), 0 10px);
        }
        .bot-avatar { font-size: 60px; }
        .bot-speech {
            background: linear-gradient(135deg, #2a2a3e, #1a1a2e);
            border: 2px solid #00d4ff;
            padding: 15px 25px;
            font-size: 1.2em;
            color: #fff;
            max-width: 400px;
            clip-path: polygon(0 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%);
        }
        .progress-container { margin: 20px 0; }
        .progress-label {
            font-family: 'Orbitron', sans-serif;
            color: #00d4ff;
            font-size: 0.9em;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }
        .progress-bar {
            height: 25px;
            background: linear-gradient(90deg, #0a0a0a, #1a1a2e);
            border: 2px solid #00d4ff;
            overflow: hidden;
            clip-path: polygon(5px 0, calc(100% - 5px) 0, 100% 5px, 100% calc(100% - 5px), calc(100% - 5px) 100%, 5px 100%, 0 calc(100% - 5px), 0 5px);
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #00d4ff, #00ffff, #00d4ff);
            transition: width 0.5s ease;
            box-shadow: 0 0 20px rgba(0, 212, 255, 0.5);
        }
        .progress-text {
            color: #00d4ff;
            text-align: right;
            margin-top: 8px;
            font-family: 'Orbitron', sans-serif;
            font-size: 1em;
        }
        .math-problem, .spelling-game, .reading-game, .colors-game, .shapes-game, .counting-game {
            text-align: center;
            padding: 20px;
        }
        .problem-display {
            font-family: 'Orbitron', sans-serif;
            font-size: 4em;
            color: #fff;
            margin: 30px 0;
            background: linear-gradient(180deg, #fff 0%, #ff6666 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .answer-buttons, .color-choices, .shape-choices, .counting-choices {
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
            margin-top: 30px;
        }
        .answer-btn, .counting-btn {
            width: 100px;
            height: 100px;
            font-family: 'Orbitron', sans-serif;
            font-size: 2.2em;
            font-weight: bold;
            border: 3px solid #666;
            cursor: pointer;
            transition: all 0.3s ease;
            background: linear-gradient(145deg, #2a2a3e, #1a1a2e);
            color: #fff;
            clip-path: polygon(10px 0, calc(100% - 10px) 0, 100% 10px, 100% calc(100% - 10px), calc(100% - 10px) 100%, 10px 100%, 0 calc(100% - 10px), 0 10px);
        }
        .answer-btn:hover, .counting-btn:hover {
            border-color: #00d4ff;
            box-shadow: 0 0 20px rgba(0, 212, 255, 0.5);
            transform: scale(1.05);
        }
        .answer-btn.correct, .counting-btn.correct, .color-btn.correct, .shape-btn.correct, .reading-choice.correct {
            background: linear-gradient(145deg, #1a3a1a, #0a2a0a);
            border-color: #33cc33;
            color: #33cc33;
            animation: correctFlash 0.5s ease;
        }
        @keyframes correctFlash {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.15); }
        }
        .answer-btn.wrong, .counting-btn.wrong, .color-btn.wrong, .shape-btn.wrong, .reading-choice.wrong {
            background: linear-gradient(145deg, #3a1a1a, #2a0a0a);
            border-color: #ff3333;
            color: #ff3333;
            animation: wrongShake 0.5s ease;
        }
        @keyframes wrongShake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }
        .word-image {
            font-size: 100px;
            margin: 15px 0;
        }
        .letter-slots {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 25px 0;
            flex-wrap: wrap;
        }
        .letter-slot {
            width: 70px;
            height: 80px;
            background: linear-gradient(145deg, #2a2a3e, #1a1a2e);
            border: 3px solid #ff8c00;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Orbitron', sans-serif;
            font-size: 2.2em;
            font-weight: bold;
            color: #666;
            clip-path: polygon(8px 0, calc(100% - 8px) 0, 100% 8px, 100% calc(100% - 8px), calc(100% - 8px) 100%, 8px 100%, 0 calc(100% - 8px), 0 8px);
        }
        .letter-slot.filled {
            background: linear-gradient(145deg, #3a2a1a, #2a1a0a);
            color: #ff8c00;
            text-shadow: 0 0 10px rgba(255, 140, 0, 0.5);
        }
        .letter-choices {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 25px;
        }
        .letter-btn {
            width: 65px;
            height: 65px;
            font-family: 'Orbitron', sans-serif;
            font-size: 1.8em;
            font-weight: bold;
            border: 2px solid #888;
            cursor: pointer;
            transition: all 0.3s ease;
            background: linear-gradient(145deg, #3a3a4e, #2a2a3e);
            color: #fff;
            clip-path: polygon(8px 0, calc(100% - 8px) 0, 100% 8px, 100% calc(100% - 8px), calc(100% - 8px) 100%, 8px 100%, 0 calc(100% - 8px), 0 8px);
        }
        .letter-btn:hover {
            border-color: #ff8c00;
            transform: scale(1.05);
        }
        .letter-btn.used {
            opacity: 0.2;
            cursor: not-allowed;
        }
        .story-text {
            background: linear-gradient(145deg, #1a2a3a, #0a1520);
            border: 2px solid #0088ff;
            padding: 25px;
            font-size: 1.6em;
            line-height: 1.8;
            color: #fff;
            margin: 20px 0;
            text-align: left;
            clip-path: polygon(10px 0, calc(100% - 10px) 0, 100% 10px, 100% calc(100% - 10px), calc(100% - 10px) 100%, 10px 100%, 0 calc(100% - 10px), 0 10px);
        }
        .highlight-word {
            background: linear-gradient(90deg, #0088ff, #00d4ff);
            color: #000;
            padding: 2px 10px;
            font-weight: bold;
        }
        .reading-question {
            background: rgba(0, 136, 255, 0.1);
            border: 1px solid rgba(0, 136, 255, 0.3);
            padding: 25px;
            margin: 20px 0;
            clip-path: polygon(10px 0, calc(100% - 10px) 0, 100% 10px, 100% calc(100% - 10px), calc(100% - 10px) 100%, 10px 100%, 0 calc(100% - 10px), 0 10px);
        }
        .reading-question p {
            font-family: 'Orbitron', sans-serif;
            color: #0088ff;
            font-size: 1.3em;
            margin-bottom: 20px;
            text-transform: uppercase;
        }
        .reading-choices {
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-width: 500px;
            margin: 0 auto;
        }
        .reading-choice {
            padding: 18px;
            font-size: 1.2em;
            border: 2px solid #555;
            cursor: pointer;
            transition: all 0.3s ease;
            background: linear-gradient(145deg, #2a2a3e, #1a1a2e);
            color: #fff;
            clip-path: polygon(10px 0, 100% 0, calc(100% - 10px) 100%, 0 100%);
            text-align: left;
            padding-left: 30px;
        }
        .reading-choice:hover {
            border-color: #0088ff;
            transform: translateX(5px);
        }
        .color-display {
            width: 180px;
            height: 180px;
            margin: 25px auto;
            border: 5px solid #fff;
            box-shadow: 0 0 30px rgba(255,255,255,0.3);
            clip-path: polygon(15px 0, calc(100% - 15px) 0, 100% 15px, 100% calc(100% - 15px), calc(100% - 15px) 100%, 15px 100%, 0 calc(100% - 15px), 0 15px);
        }
        .color-btn, .shape-btn {
            padding: 18px 35px;
            font-family: 'Orbitron', sans-serif;
            font-size: 1.2em;
            font-weight: bold;
            border: 2px solid #555;
            cursor: pointer;
            transition: all 0.3s ease;
            background: linear-gradient(145deg, #2a2a3e, #1a1a2e);
            color: #fff;
            clip-path: polygon(10px 0, calc(100% - 10px) 0, 100% 10px, 100% calc(100% - 10px), calc(100% - 10px) 100%, 10px 100%, 0 calc(100% - 10px), 0 10px);
            text-transform: uppercase;
            letter-spacing: 2px;
        }
        .color-btn:hover, .shape-btn:hover {
            border-color: #ffd700;
            transform: scale(1.05);
        }
        .shape-display {
            width: 200px;
            height: 200px;
            margin: 30px auto;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .shape { filter: drop-shadow(0 0 20px rgba(255, 215, 0, 0.5)); }
        .shape.circle { width: 150px; height: 150px; background: linear-gradient(135deg, #ffd700, #ffaa00); border-radius: 50%; }
        .shape.square { width: 140px; height: 140px; background: linear-gradient(135deg, #ff6b6b, #ee5a5a); }
        .shape.triangle { width: 0; height: 0; border-left: 80px solid transparent; border-right: 80px solid transparent; border-bottom: 140px solid #33cc33; }
        .shape.rectangle { width: 180px; height: 100px; background: linear-gradient(135deg, #0088ff, #0066cc); }
        .shape.star { font-size: 150px; color: #ffd700; }
        .shape.heart { font-size: 150px; color: #ff6b6b; }
        .counting-display {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 15px;
            margin: 30px auto;
            max-width: 400px;
            padding: 20px;
            background: rgba(0,0,0,0.3);
            border-radius: 20px;
        }
        .counting-item {
            font-size: 50px;
            animation: countPop 0.3s ease;
        }
        @keyframes countPop {
            0% { transform: scale(0); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        .counting-question {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.5em;
            color: #fff;
            margin: 20px 0;
        }
        .celebration {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            display: none;
            align-items: center;
            justify-content: center;
            background: rgba(0,0,0,0.9);
            z-index: 1000;
        }
        .celebration.active { display: flex; }
        .celebration-content {
            text-align: center;
            animation: celebrateZoom 0.5s ease;
            padding: 40px;
            background: linear-gradient(145deg, #1a1a2e, #0d1b2a);
            border: 4px solid #ffd700;
            clip-path: polygon(20px 0, calc(100% - 20px) 0, 100% 20px, 100% calc(100% - 20px), calc(100% - 20px) 100%, 20px 100%, 0 calc(100% - 20px), 0 20px);
        }
        @keyframes celebrateZoom {
            0% { transform: scale(0) rotate(-10deg); opacity: 0; }
            100% { transform: scale(1) rotate(0deg); opacity: 1; }
        }
        .celebration h2 {
            font-family: 'Orbitron', sans-serif;
            font-size: 3em;
            color: #ffd700;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
            text-transform: uppercase;
            letter-spacing: 5px;
        }
        .celebration .emoji { font-size: 80px; display: block; margin: 15px; }
        .celebration p { color: #00d4ff; font-size: 1.3em; font-family: 'Orbitron', sans-serif; }
        .energon-earned { color: #ffd700; font-size: 1.5em; margin-top: 15px; font-family: 'Orbitron', sans-serif; }
        .energon-burst {
            position: absolute;
            width: 8px; height: 8px;
            background: linear-gradient(135deg, #00ffff, #0088ff);
            clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%);
            animation: burstOut 2s ease-out forwards;
        }
        @keyframes burstOut {
            0% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
            100% { transform: translate(var(--x), var(--y)) scale(0); opacity: 0; }
        }
        .next-btn {
            background: linear-gradient(135deg, #1a3a1a, #0a2a0a);
            border: 3px solid #33cc33;
            color: #33cc33;
            padding: 18px 45px;
            font-family: 'Orbitron', sans-serif;
            font-size: 1.2em;
            cursor: pointer;
            margin-top: 25px;
            display: none;
            text-transform: uppercase;
            letter-spacing: 3px;
            clip-path: polygon(15px 0, calc(100% - 15px) 0, 100% 15px, 100% calc(100% - 15px), calc(100% - 15px) 100%, 15px 100%, 0 calc(100% - 15px), 0 15px);
        }
        .next-btn.visible { display: inline-block; animation: readyPulse 1.5s infinite; }
        @keyframes readyPulse {
            0%, 100% { box-shadow: 0 0 10px rgba(51, 204, 51, 0.3); }
            50% { box-shadow: 0 0 25px rgba(51, 204, 51, 0.6); }
        }
        .next-btn:hover { background: #33cc33; color: #000; }
        .sound-toggle {
            position: fixed;
            top: 20px; left: 20px;
            background: linear-gradient(135deg, #1a1a2e, #0d1b2a);
            border: 2px solid #00d4ff;
            width: 50px; height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 100;
            font-size: 1.3em;
            clip-path: polygon(8px 0, calc(100% - 8px) 0, 100% 8px, 100% calc(100% - 8px), calc(100% - 8px) 100%, 8px 100%, 0 calc(100% - 8px), 0 8px);
        }
        .sound-toggle:hover { background: #00d4ff; }
        .unlock-animation {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            display: none;
            align-items: center;
            justify-content: center;
            background: rgba(0,0,0,0.95);
            z-index: 3000;
        }
        .unlock-animation.active { display: flex; }
        .unlock-content { text-align: center; animation: unlockZoom 1s ease; }
        @keyframes unlockZoom {
            0% { transform: scale(0) rotate(-180deg); opacity: 0; }
            50% { transform: scale(1.2) rotate(10deg); }
            100% { transform: scale(1) rotate(0deg); opacity: 1; }
        }
        .unlock-content .bot-unlock-icon { font-size: 150px; display: block; margin-bottom: 20px; animation: unlockGlow 1s ease infinite; }
        @keyframes unlockGlow {
            0%, 100% { filter: drop-shadow(0 0 20px rgba(255, 215, 0, 0.5)); }
            50% { filter: drop-shadow(0 0 40px rgba(255, 215, 0, 0.8)); }
        }
        .unlock-content h2 { font-family: 'Orbitron', sans-serif; font-size: 2.5em; color: #ffd700; text-transform: uppercase; letter-spacing: 5px; }
        .unlock-content p { font-family: 'Orbitron', sans-serif; font-size: 1.5em; color: #00d4ff; }
        /* Grade Selector Styles */
        .grade-selector {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0 30px;
            flex-wrap: wrap;
        }
        .grade-btn {
            background: linear-gradient(145deg, #1a1a2e, #0d1b2a);
            border: 3px solid #555;
            padding: 15px 25px;
            font-family: 'Orbitron', sans-serif;
            font-size: 1em;
            color: #888;
            cursor: pointer;
            transition: all 0.3s ease;
            clip-path: polygon(10px 0, calc(100% - 10px) 0, 100% 10px, 100% calc(100% - 10px), calc(100% - 10px) 100%, 10px 100%, 0 calc(100% - 10px), 0 10px);
            text-transform: uppercase;
            letter-spacing: 2px;
            min-width: 160px;
            text-align: center;
        }
        .grade-btn:hover {
            border-color: #00d4ff;
            color: #00d4ff;
            transform: scale(1.05);
        }
        .grade-btn.active {
            border-color: #ffd700;
            color: #ffd700;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.4);
        }
        .grade-btn.kindergarten.active { border-color: #33cc33; color: #33cc33; box-shadow: 0 0 20px rgba(51, 204, 51, 0.4); }
        .grade-btn.grade1.active { border-color: #ffd700; color: #ffd700; box-shadow: 0 0 20px rgba(255, 215, 0, 0.4); }
        .grade-btn.grade2.active { border-color: #ff6b6b; color: #ff6b6b; box-shadow: 0 0 20px rgba(255, 107, 107, 0.4); }
        .grade-stars {
            display: block;
            font-size: 1.2em;
            margin-bottom: 5px;
        }
        .grade-label {
            display: block;
            font-size: 0.9em;
        }
        .current-grade-display {
            font-family: 'Orbitron', sans-serif;
            font-size: 0.9em;
            color: #888;
            text-align: center;
            margin-top: 5px;
            letter-spacing: 2px;
        }
        .current-grade-display span {
            color: #ffd700;
        }
        /* 3D Shape styles */
        .shape.cube {
            width: 100px;
            height: 100px;
            position: relative;
            transform-style: preserve-3d;
            transform: rotateX(-20deg) rotateY(30deg);
            animation: rotateCube 4s linear infinite;
        }
        @keyframes rotateCube {
            0% { transform: rotateX(-20deg) rotateY(0deg); }
            100% { transform: rotateX(-20deg) rotateY(360deg); }
        }
        .cube-face {
            position: absolute;
            width: 100px;
            height: 100px;
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
            border: 2px solid rgba(255,255,255,0.3);
            opacity: 0.9;
        }
        .cube-face.front { transform: translateZ(50px); }
        .cube-face.back { transform: translateZ(-50px) rotateY(180deg); }
        .cube-face.left { transform: translateX(-50px) rotateY(-90deg); }
        .cube-face.right { transform: translateX(50px) rotateY(90deg); }
        .cube-face.top { transform: translateY(-50px) rotateX(90deg); }
        .cube-face.bottom { transform: translateY(50px) rotateX(-90deg); }
        .shape.sphere {
            width: 120px;
            height: 120px;
            background: radial-gradient(circle at 30% 30%, #74b9ff, #0984e3, #0652DD);
            border-radius: 50%;
            box-shadow: inset -20px -20px 40px rgba(0,0,0,0.3), 0 0 30px rgba(116, 185, 255, 0.5);
        }
        .shape.cylinder {
            width: 80px;
            height: 120px;
            background: linear-gradient(90deg, #00b894, #00a085, #00b894);
            border-radius: 40px / 20px;
            position: relative;
        }
        .shape.cylinder::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 80px;
            height: 40px;
            background: linear-gradient(135deg, #55efc4, #00b894);
            border-radius: 50%;
        }
        .shape.cone {
            width: 0;
            height: 0;
            border-left: 60px solid transparent;
            border-right: 60px solid transparent;
            border-bottom: 120px solid #e17055;
            position: relative;
        }
        .shape.cone::after {
            content: '';
            position: absolute;
            bottom: -130px;
            left: -60px;
            width: 120px;
            height: 30px;
            background: #d63031;
            border-radius: 50%;
        }
        .shape.pentagon {
            width: 120px;
            height: 114px;
            background: linear-gradient(135deg, #a29bfe, #6c5ce7);
            clip-path: polygon(50% 0%, 100% 38%, 82% 100%, 18% 100%, 0% 38%);
        }
        .shape.hexagon {
            width: 120px;
            height: 104px;
            background: linear-gradient(135deg, #fd79a8, #e84393);
            clip-path: polygon(25% 0%, 75% 0%, 100% 50%, 75% 100%, 25% 100%, 0% 50%);
        }
        .shape.oval {
            width: 150px;
            height: 90px;
            background: linear-gradient(135deg, #81ecec, #00cec9);
            border-radius: 50%;
        }
        .shape.diamond {
            width: 100px;
            height: 100px;
            background: linear-gradient(135deg, #ffeaa7, #fdcb6e);
            transform: rotate(45deg);
        }
        /* Rewards Shop Styles */
        .rewards-section {
            margin-top: 30px;
        }
        .rewards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            padding: 20px;
        }
        .reward-card {
            background: linear-gradient(145deg, #1a1a2e, #0d1b2a);
            border: 3px solid #555;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            clip-path: polygon(0 10px, 10px 0, calc(100% - 10px) 0, 100% 10px, 100% calc(100% - 10px), calc(100% - 10px) 100%, 10px 100%, 0 calc(100% - 10px));
        }
        .reward-card:hover {
            transform: translateY(-3px);
            border-color: #00d4ff;
        }
        .reward-card.owned {
            border-color: #33cc33;
            opacity: 0.8;
        }
        .reward-card.owned::after {
            content: '‚úì OWNED';
            display: block;
            color: #33cc33;
            font-family: 'Orbitron', sans-serif;
            font-size: 0.8em;
            margin-top: 10px;
        }
        .reward-card.active-reward {
            border-color: #ffd700;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.4);
        }
        .reward-card.active-reward::after {
            content: '‚òÖ ACTIVE';
            display: block;
            color: #ffd700;
            font-family: 'Orbitron', sans-serif;
            font-size: 0.8em;
            margin-top: 10px;
        }
        .reward-icon {
            font-size: 50px;
            display: block;
            margin-bottom: 10px;
        }
        .reward-name {
            font-family: 'Orbitron', sans-serif;
            font-size: 1em;
            color: #fff;
            margin-bottom: 5px;
        }
        .reward-desc {
            font-size: 0.85em;
            color: #888;
            margin-bottom: 10px;
        }
        .reward-price {
            font-family: 'Orbitron', sans-serif;
            font-size: 1em;
            color: #00d4ff;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        .reward-price .energon-icon { width: 14px; height: 14px; }
        .shop-toggle {
            background: linear-gradient(135deg, #ffd700, #ffaa00);
            color: #000;
            border: none;
            padding: 12px 30px;
            font-family: 'Orbitron', sans-serif;
            font-size: 1em;
            cursor: pointer;
            margin: 20px auto;
            display: block;
            text-transform: uppercase;
            letter-spacing: 2px;
            clip-path: polygon(10px 0, calc(100% - 10px) 0, 100% 10px, 100% calc(100% - 10px), calc(100% - 10px) 100%, 10px 100%, 0 calc(100% - 10px), 0 10px);
            transition: all 0.3s ease;
        }
        .shop-toggle:hover {
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
        }
        .shop-section {
            display: none;
            margin-top: 20px;
        }
        .shop-section.visible { display: block; }
        .theme-preview {
            width: 100%;
            height: 60px;
            margin-top: 10px;
            border-radius: 5px;
        }
        .theme-cyber { background: linear-gradient(90deg, #0a0a0a, #1a1a2e, #0d1b2a); }
        .theme-rescue { background: linear-gradient(90deg, #ff3333, #ff8c00, #ffd700); }
        .theme-nature { background: linear-gradient(90deg, #2ecc71, #27ae60, #1abc9c); }
        .theme-space { background: linear-gradient(90deg, #2c3e50, #8e44ad, #3498db); }
        .powerup-badge {
            position: fixed;
            top: 80px;
            right: 20px;
            background: linear-gradient(135deg, #1a1a2e, #0d1b2a);
            border: 2px solid #ffd700;
            padding: 8px 15px;
            font-family: 'Orbitron', sans-serif;
            font-size: 0.9em;
            color: #ffd700;
            z-index: 100;
            clip-path: polygon(8px 0, calc(100% - 8px) 0, 100% 8px, 100% calc(100% - 8px), calc(100% - 8px) 100%, 8px 100%, 0 calc(100% - 8px), 0 8px);
            display: none;
        }
        .powerup-badge.visible { display: block; }
        /* Color mixing display */
        .color-mix-display {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin: 20px auto;
        }
        .color-mix-box {
            width: 80px;
            height: 80px;
            border: 3px solid #fff;
            clip-path: polygon(10px 0, calc(100% - 10px) 0, 100% 10px, 100% calc(100% - 10px), calc(100% - 10px) 100%, 10px 100%, 0 calc(100% - 10px), 0 10px);
        }
        .color-mix-plus {
            font-family: 'Orbitron', sans-serif;
            font-size: 2em;
            color: #ffd700;
        }
        .color-mix-equals {
            font-family: 'Orbitron', sans-serif;
            font-size: 2em;
            color: #00d4ff;
        }
        .color-mix-result {
            width: 80px;
            height: 80px;
            border: 3px solid #ffd700;
            background: linear-gradient(45deg, #333 25%, transparent 25%, transparent 75%, #333 75%), linear-gradient(45deg, #333 25%, transparent 25%, transparent 75%, #333 75%);
            background-size: 20px 20px;
            background-position: 0 0, 10px 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Orbitron', sans-serif;
            font-size: 2em;
            color: #ffd700;
            clip-path: polygon(10px 0, calc(100% - 10px) 0, 100% 10px, 100% calc(100% - 10px), calc(100% - 10px) 100%, 10px 100%, 0 calc(100% - 10px), 0 10px);
        }
        @media (max-width: 768px) {
            h1 { font-size: 1.8em; }
            .subtitle { font-size: 1em; letter-spacing: 4px; }
            .problem-display { font-size: 2.5em; }
            .answer-btn, .counting-btn { width: 75px; height: 75px; font-size: 1.6em; }
            .letter-slot, .letter-btn { width: 55px; height: 60px; font-size: 1.4em; }
            .score-display { padding: 10px 15px; font-size: 1em; }
            .grade-btn { min-width: 120px; padding: 12px 15px; font-size: 0.9em; }
        }
    </style>
</head>
<body>
    <div class="cyber-grid"></div>
    <div id="energonParticles"></div>

    <!-- Transformation Animation Overlay -->
    <div class="transform-overlay" id="transformOverlay">
        <div class="transform-stage">
            <div class="transform-sparks" id="transformSparks"></div>
            <div class="vehicle-form" id="vehicleForm">üöí</div>
            <div class="robot-form" id="robotForm">ü§ñ</div>
        </div>
        <div class="transform-text-overlay" id="transformTextOverlay">TRANSFORM!</div>
        <div class="bot-name-transform" id="botNameTransform">HEATWAVE</div>
    </div>

    <button class="sound-toggle" id="soundToggle" onclick="toggleSound()">üîä</button>

    <div class="score-display" onclick="showShopHint()">
        <span class="energon-icon"></span>
        <span id="totalScore">0</span> ENERGON
        <span class="shop-hint">Tap to see unlocks!</span>
    </div>

    <div class="container">
        <header>
            <div class="autobot-logo">
                <svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M50 5 L65 25 L95 30 L75 50 L80 80 L50 65 L20 80 L25 50 L5 30 L35 25 Z" fill="#ff3333" stroke="#ff6666" stroke-width="2"/>
                    <path d="M50 20 L58 32 L50 75 L42 32 Z" fill="#cc0000"/>
                    <circle cx="50" cy="40" r="8" fill="#fff"/>
                    <circle cx="50" cy="40" r="4" fill="#00d4ff"/>
                </svg>
            </div>
            <h1>RESCUE BOTS</h1>
            <p class="subtitle">Academy</p>
            <p class="tagline">‚ö° HI STEVEN! TRANSFORM AND ROLL OUT! ‚ö°</p>

            <div class="grade-selector" id="gradeSelector">
                <button class="grade-btn kindergarten active" onclick="selectGrade('kindergarten')">
                    <span class="grade-stars">‚≠ê</span>
                    <span class="grade-label">Kindergarten</span>
                </button>
                <button class="grade-btn grade1" onclick="selectGrade('grade1')">
                    <span class="grade-stars">‚≠ê‚≠ê</span>
                    <span class="grade-label">1st Grade</span>
                </button>
                <button class="grade-btn grade2" onclick="selectGrade('grade2')">
                    <span class="grade-stars">‚≠ê‚≠ê‚≠ê</span>
                    <span class="grade-label">2nd Grade</span>
                </button>
            </div>
            <p class="current-grade-display">Current Level: <span id="currentGradeLabel">Kindergarten</span></p>
        </header>

        <p class="section-title">ü§ñ RESCUE BOTS TEAM ü§ñ</p>
        <div class="main-menu" id="mainMenu">
            <div class="menu-card heatwave" onclick="startGame('math')">
                <span class="bot-icon">üöí</span>
                <p class="mission-type">Math Mission</p>
                <h2 class="bot-color">HEATWAVE</h2>
                <p class="description">Emergency number rescue!</p>
                <div class="status-ready">READY</div>
            </div>
            <div class="menu-card blades" onclick="startGame('spelling')">
                <span class="bot-icon">üöÅ</span>
                <p class="mission-type">Spelling Mission</p>
                <h2 class="bot-color">BLADES</h2>
                <p class="description">Aerial word patrol!</p>
                <div class="status-ready">READY</div>
            </div>
            <div class="menu-card chase" onclick="startGame('reading')">
                <span class="bot-icon">üöî</span>
                <p class="mission-type">Reading Mission</p>
                <h2 class="bot-color">CHASE</h2>
                <p class="description">Story investigation!</p>
                <div class="status-ready">READY</div>
            </div>
            <div class="menu-card boulder" onclick="startGame('colors')">
                <span class="bot-icon">üöú</span>
                <p class="mission-type">Color Mission</p>
                <h2 class="bot-color">BOULDER</h2>
                <p class="description">Construction color ID!</p>
                <div class="status-ready">READY</div>
            </div>
        </div>

        <p class="section-title locked-section" id="lockedTitle">üîí LEGENDARY AUTOBOTS üîí</p>
        <div class="main-menu" id="lockedMenu">
            <div class="menu-card bumblebee" id="bumblebeeCard" onclick="handleLockedClick('bumblebee')">
                <div class="lock-overlay" id="bumblebeeLock">
                    <span class="lock-icon">üîí</span>
                    <div class="lock-price"><span class="energon-icon"></span><span>500 ENERGON</span></div>
                    <button class="unlock-btn" id="bumblebeeUnlockBtn" onclick="event.stopPropagation(); unlockBot('bumblebee', 500)">UNLOCK</button>
                </div>
                <span class="bot-icon" style="filter: hue-rotate(40deg) saturate(1.5) brightness(1.2);">üöó</span>
                <p class="mission-type">Shapes Mission</p>
                <h2 class="bot-color">BUMBLEBEE</h2>
                <p class="description">Shape scout training!</p>
                <div class="status-ready">READY</div>
            </div>
            <div class="menu-card optimus" id="optimusCard" onclick="handleLockedClick('optimus')">
                <div class="lock-overlay" id="optimusLock">
                    <span class="lock-icon">üîí</span>
                    <div class="lock-price"><span class="energon-icon"></span><span>1000 ENERGON</span></div>
                    <button class="unlock-btn" id="optimusUnlockBtn" onclick="event.stopPropagation(); unlockBot('optimus', 1000)">UNLOCK</button>
                </div>
                <span class="bot-icon">üöõ</span>
                <p class="mission-type">Counting Mission</p>
                <h2 class="bot-color">OPTIMUS PRIME</h2>
                <p class="description">Leader counting challenge!</p>
                <div class="status-ready">READY</div>
            </div>
        </div>

        <!-- Story Mode Section (unlockable) -->
        <p class="section-title locked-section" id="storyTitle">üìñ STORY MODE üìñ</p>
        <div class="main-menu" id="storyMenu">
            <div class="menu-card chase" id="storyCard" onclick="handleLockedClick('storymode')">
                <div class="lock-overlay" id="storymodeLock">
                    <span class="lock-icon">üîí</span>
                    <div class="lock-price"><span class="energon-icon"></span><span>750 ENERGON</span></div>
                    <button class="unlock-btn" id="storymodeUnlockBtn" onclick="event.stopPropagation(); unlockBot('storymode', 750)">UNLOCK</button>
                </div>
                <span class="bot-icon">üìö</span>
                <p class="mission-type">Adventure Reading</p>
                <h2 class="bot-color">RESCUE STORIES</h2>
                <p class="description">Read exciting rescue adventures!</p>
                <div class="status-ready">READY</div>
            </div>
        </div>

        <!-- Rewards Shop Section -->
        <button class="shop-toggle" id="shopToggle" onclick="toggleShop()">üéÅ REWARDS SHOP üéÅ</button>
        <div class="shop-section" id="shopSection">
            <p class="section-title">üèÜ POWER-UPS üèÜ</p>
            <div class="rewards-grid" id="powerupsGrid"></div>

            <p class="section-title">üé® THEMES üé®</p>
            <div class="rewards-grid" id="themesGrid"></div>

            <p class="section-title">üèÖ BADGES üèÖ</p>
            <div class="rewards-grid" id="badgesGrid"></div>
        </div>

        <!-- Game Screens -->
        <div class="game-screen" id="mathScreen">
            <button class="back-btn" onclick="goBack()">‚óÑ ABORT MISSION</button>
            <div class="game-header heatwave"><h2>üöí HEATWAVE MATH RESCUE üöí</h2></div>
            <div class="progress-container">
                <p class="progress-label">Mission Progress</p>
                <div class="progress-bar"><div class="progress-fill" id="mathProgress" style="width: 0%"></div></div>
                <p class="progress-text"><span id="mathCount">0</span> / 5 OBJECTIVES</p>
            </div>
            <div class="bot-helper">
                <span class="bot-avatar">ü§ñ</span>
                <div class="bot-speech" id="mathSpeech">Steven! Calculate the answer!</div>
            </div>
            <div class="math-problem">
                <div class="problem-display" id="mathProblem">1 + 1 = ?</div>
                <div class="answer-buttons" id="mathAnswers"></div>
            </div>
            <button class="next-btn" id="mathNext" onclick="nextMathProblem()">NEXT OBJECTIVE ‚ñ∫</button>
        </div>

        <div class="game-screen" id="spellingScreen">
            <button class="back-btn" onclick="goBack()">‚óÑ ABORT MISSION</button>
            <div class="game-header blades"><h2>üöÅ BLADES SPELLING PATROL üöÅ</h2></div>
            <div class="progress-container">
                <p class="progress-label">Mission Progress</p>
                <div class="progress-bar"><div class="progress-fill" id="spellingProgress" style="width: 0%"></div></div>
                <p class="progress-text"><span id="spellingCount">0</span> / 5 OBJECTIVES</p>
            </div>
            <div class="bot-helper">
                <span class="bot-avatar">ü§ñ</span>
                <div class="bot-speech" id="spellingSpeech">Aerial scan complete! Spell the target!</div>
            </div>
            <div class="spelling-game">
                <div class="word-image" id="wordImage">üê±</div>
                <div class="letter-slots" id="letterSlots"></div>
                <div class="letter-choices" id="letterChoices"></div>
            </div>
            <button class="next-btn" id="spellingNext" onclick="nextSpellingWord()">NEXT OBJECTIVE ‚ñ∫</button>
        </div>

        <div class="game-screen" id="readingScreen">
            <button class="back-btn" onclick="goBack()">‚óÑ ABORT MISSION</button>
            <div class="game-header chase"><h2>üöî CHASE STORY INVESTIGATION üöî</h2></div>
            <div class="progress-container">
                <p class="progress-label">Mission Progress</p>
                <div class="progress-bar"><div class="progress-fill" id="readingProgress" style="width: 0%"></div></div>
                <p class="progress-text"><span id="readingCount">0</span> / 5 OBJECTIVES</p>
            </div>
            <div class="bot-helper">
                <span class="bot-avatar">ü§ñ</span>
                <div class="bot-speech" id="readingSpeech">Read the report and solve the case!</div>
            </div>
            <div class="reading-game">
                <div class="story-text" id="storyText"></div>
                <div class="reading-question">
                    <p id="readingQuestion">CASE QUESTION:</p>
                    <div class="reading-choices" id="readingChoices"></div>
                </div>
            </div>
            <button class="next-btn" id="readingNext" onclick="nextReadingStory()">NEXT OBJECTIVE ‚ñ∫</button>
        </div>

        <div class="game-screen" id="colorsScreen">
            <button class="back-btn" onclick="goBack()">‚óÑ ABORT MISSION</button>
            <div class="game-header boulder"><h2>üöú BOULDER COLOR CONSTRUCTION üöú</h2></div>
            <div class="progress-container">
                <p class="progress-label">Mission Progress</p>
                <div class="progress-bar"><div class="progress-fill" id="colorsProgress" style="width: 0%"></div></div>
                <p class="progress-text"><span id="colorsCount">0</span> / 5 OBJECTIVES</p>
            </div>
            <div class="bot-helper">
                <span class="bot-avatar">ü§ñ</span>
                <div class="bot-speech" id="colorsSpeech">Identify the construction material color!</div>
            </div>
            <div class="colors-game">
                <div class="color-display" id="colorDisplay" style="background: red;"></div>
                <div class="color-choices" id="colorChoices"></div>
            </div>
            <button class="next-btn" id="colorsNext" onclick="nextColorQuestion()">NEXT OBJECTIVE ‚ñ∫</button>
        </div>

        <div class="game-screen" id="shapesScreen">
            <button class="back-btn" onclick="goBack()">‚óÑ ABORT MISSION</button>
            <div class="game-header bumblebee"><h2>üöó BUMBLEBEE SHAPE SCOUT üöó</h2></div>
            <div class="progress-container">
                <p class="progress-label">Mission Progress</p>
                <div class="progress-bar"><div class="progress-fill" id="shapesProgress" style="width: 0%"></div></div>
                <p class="progress-text"><span id="shapesCount">0</span> / 5 OBJECTIVES</p>
            </div>
            <div class="bot-helper">
                <span class="bot-avatar">ü§ñ</span>
                <div class="bot-speech" id="shapesSpeech">Bzzz! What shape do you see, friend?</div>
            </div>
            <div class="shapes-game">
                <div class="shape-display" id="shapeDisplay"></div>
                <div class="shape-choices" id="shapeChoices"></div>
            </div>
            <button class="next-btn" id="shapesNext" onclick="nextShapeQuestion()">NEXT OBJECTIVE ‚ñ∫</button>
        </div>

        <div class="game-screen" id="countingScreen">
            <button class="back-btn" onclick="goBack()">‚óÑ ABORT MISSION</button>
            <div class="game-header optimus"><h2>üöõ OPTIMUS PRIME COUNTING üöõ</h2></div>
            <div class="progress-container">
                <p class="progress-label">Mission Progress</p>
                <div class="progress-bar"><div class="progress-fill" id="countingProgress" style="width: 0%"></div></div>
                <p class="progress-text"><span id="countingCount">0</span> / 5 OBJECTIVES</p>
            </div>
            <div class="bot-helper">
                <span class="bot-avatar">ü§ñ</span>
                <div class="bot-speech" id="countingSpeech">Autobots, count with me!</div>
            </div>
            <div class="counting-game">
                <div class="counting-display" id="countingDisplay"></div>
                <p class="counting-question" id="countingQuestion">How many do you see?</p>
                <div class="counting-choices" id="countingChoices"></div>
            </div>
            <button class="next-btn" id="countingNext" onclick="nextCountingQuestion()">NEXT OBJECTIVE ‚ñ∫</button>
        </div>

        <!-- Story Mode Screen -->
        <div class="game-screen" id="storyScreen">
            <button class="back-btn" onclick="goBack()">‚óÑ ABORT MISSION</button>
            <div class="game-header chase"><h2>üìö RESCUE BOTS STORY TIME üìö</h2></div>
            <div class="progress-container">
                <p class="progress-label">Story Progress</p>
                <div class="progress-bar"><div class="progress-fill" id="storyProgress" style="width: 0%"></div></div>
                <p class="progress-text">Chapter <span id="storyChapter">1</span> of <span id="storyTotalChapters">5</span></p>
            </div>
            <div class="bot-helper">
                <span class="bot-avatar" id="storyBotAvatar">ü§ñ</span>
                <div class="bot-speech" id="storySpeech">Let's read a rescue adventure!</div>
            </div>
            <div class="reading-game">
                <h3 id="storyTitle2" style="font-family: 'Orbitron', sans-serif; color: #ffd700; text-align: center; margin-bottom: 20px; font-size: 1.5em;"></h3>
                <div class="story-text" id="storyFullText" style="font-size: 1.4em; line-height: 2;"></div>
                <div id="storyQuestionSection" style="display: none;">
                    <div class="reading-question">
                        <p id="storyQuestion">STORY QUESTION:</p>
                        <div class="reading-choices" id="storyChoices"></div>
                    </div>
                </div>
                <button class="next-btn visible" id="storyContinue" onclick="continueStory()" style="display: block;">CONTINUE READING ‚ñ∫</button>
            </div>
            <button class="next-btn" id="storyNext" onclick="nextStoryChapter()">NEXT CHAPTER ‚ñ∫</button>
        </div>
    </div>

    <div class="powerup-badge" id="powerupBadge">‚ö° 2X ENERGON ACTIVE</div>

    <div class="celebration" id="celebration">
        <div class="celebration-content">
            <h2 id="celebrationTitle">MISSION COMPLETE!</h2>
            <span class="emoji" id="celebrationBot">ü§ñ</span>
            <p id="celebrationMessage">Outstanding work, Steven!</p>
            <p class="energon-earned" id="energonEarned">+50 ENERGON!</p>
        </div>
    </div>

    <div class="unlock-animation" id="unlockAnimation">
        <div class="unlock-content">
            <span class="bot-unlock-icon" id="unlockBotIcon">üöó</span>
            <h2 id="unlockBotName">BUMBLEBEE</h2>
            <p>UNLOCKED!</p>
        </div>
    </div>

    <script>
        // Bot data with vehicle and robot forms
        const botData = {
            math: { vehicle: 'üöí', robot: 'ü§ñ', name: 'HEATWAVE', color: '#ff3333' },
            spelling: { vehicle: 'üöÅ', robot: 'ü§ñ', name: 'BLADES', color: '#ff8c00' },
            reading: { vehicle: 'üöî', robot: 'ü§ñ', name: 'CHASE', color: '#0088ff' },
            colors: { vehicle: 'üöú', robot: 'ü§ñ', name: 'BOULDER', color: '#33cc33' },
            shapes: { vehicle: 'üöó', robot: 'ü§ñ', name: 'BUMBLEBEE', color: '#ffd700', isYellow: true },
            counting: { vehicle: 'üöõ', robot: 'ü§ñ', name: 'OPTIMUS PRIME', color: '#ff0000' }
        };

        let totalScore = 0;
        let soundEnabled = true;
        let currentGame = '';
        let currentGrade = 'kindergarten'; // 'kindergarten', 'grade1', 'grade2'
        let unlockedBots = { bumblebee: false, optimus: false, storymode: false };
        const botPrices = { bumblebee: 500, optimus: 1000, storymode: 750 };

        // Rewards system
        let ownedRewards = { powerups: [], themes: ['cyber'], badges: [] };
        let activeTheme = 'cyber';
        let activePowerup = null;
        let powerupEndTime = 0;

        // Shop items
        const shopItems = {
            powerups: [
                { id: 'double_energon', name: '2X Energon', icon: '‚ö°', desc: 'Double energon for 10 min', price: 250, duration: 600000 },
                { id: 'hint_helper', name: 'Hint Helper', icon: 'üí°', desc: 'Get hints on hard questions', price: 400, duration: 600000 },
                { id: 'extra_time', name: 'Extra Time', icon: '‚è∞', desc: 'More time on timed modes', price: 300, duration: 600000 }
            ],
            themes: [
                { id: 'cyber', name: 'Cyber Base', icon: 'üåÉ', desc: 'Default cyber theme', price: 0, colors: ['#0a0a0a', '#1a1a2e', '#0d1b2a'] },
                { id: 'rescue', name: 'Rescue Red', icon: 'üöí', desc: 'Hot rescue colors', price: 400, colors: ['#2a0a0a', '#3a1515', '#1a0505'] },
                { id: 'nature', name: 'Nature Base', icon: 'üå≤', desc: 'Calm green theme', price: 400, colors: ['#0a2a0a', '#153a15', '#051a05'] },
                { id: 'space', name: 'Space Station', icon: 'üöÄ', desc: 'Deep space purple', price: 600, colors: ['#1a0a2a', '#251540', '#0f051a'] }
            ],
            badges: [
                { id: 'math_master', name: 'Math Master', icon: 'üßÆ', desc: 'Complete 10 math missions', price: 0, requirement: { type: 'missions', game: 'math', count: 10 } },
                { id: 'spelling_star', name: 'Spelling Star', icon: 'üìù', desc: 'Complete 10 spelling missions', price: 0, requirement: { type: 'missions', game: 'spelling', count: 10 } },
                { id: 'reading_pro', name: 'Reading Pro', icon: 'üìñ', desc: 'Complete 10 reading missions', price: 0, requirement: { type: 'missions', game: 'reading', count: 10 } },
                { id: 'energon_collector', name: 'Energon Collector', icon: 'üíé', desc: 'Collect 2000 total energon', price: 0, requirement: { type: 'score', count: 2000 } },
                { id: 'super_hero', name: 'Super Hero', icon: 'ü¶∏', desc: 'Unlock all bots', price: 0, requirement: { type: 'unlockAll' } }
            ]
        };

        // Mission completion tracking
        let missionStats = { math: 0, spelling: 0, reading: 0, colors: 0, shapes: 0, counting: 0, story: 0 };
        let totalEnergonEarned = 0;

        // Story mode variables
        let currentStoryData = null;
        let currentStoryChapter = 0;
        let currentStoryPart = 0;
        let storyQuestionAnswered = false;

        // Grade configuration
        const gradeData = {
            kindergarten: { label: 'Kindergarten', stars: 1, color: '#33cc33' },
            grade1: { label: '1st Grade', stars: 2, color: '#ffd700' },
            grade2: { label: '2nd Grade', stars: 3, color: '#ff6b6b' }
        };

        // Game states
        let mathProblemCount = 0, currentMathProblem = null;
        let spellingWordCount = 0, currentWord = '', currentLetterIndex = 0;
        let readingStoryCount = 0, currentStory = null;
        let colorsQuestionCount = 0, currentColor = null, currentColorMix = null;
        let shapesQuestionCount = 0, currentShape = null;
        let countingQuestionCount = 0, currentCount = 0, currentCountType = 'normal';

        // Spelling words by grade
        const spellingWordsByGrade = {
            kindergarten: [
                { word: 'CAT', image: 'üê±' }, { word: 'DOG', image: 'üêï' }, { word: 'SUN', image: '‚òÄÔ∏è' },
                { word: 'BUS', image: 'üöå' }, { word: 'HAT', image: 'üé©' }, { word: 'CUP', image: '‚òï' },
                { word: 'BED', image: 'üõèÔ∏è' }, { word: 'PIG', image: 'üê∑' }, { word: 'BEE', image: 'üêù' },
                { word: 'CAR', image: 'üöó' }, { word: 'BOT', image: 'ü§ñ' }, { word: 'RED', image: 'üî¥' }
            ],
            grade1: [
                { word: 'FIRE', image: 'üî•' }, { word: 'HELP', image: 'üÜò' }, { word: 'SAVE', image: 'üí™' },
                { word: 'HERO', image: 'ü¶∏' }, { word: 'TEAM', image: 'üë•' }, { word: 'FAST', image: 'üí®' },
                { word: 'SAFE', image: 'üõ°Ô∏è' }, { word: 'JUMP', image: 'ü¶ò' }, { word: 'ROCK', image: 'ü™®' },
                { word: 'TREE', image: 'üå≥' }, { word: 'BIRD', image: 'üê¶' }, { word: 'FISH', image: 'üêü' }
            ],
            grade2: [
                { word: 'RESCUE', image: 'üöë' }, { word: 'DANGER', image: '‚ö†Ô∏è' }, { word: 'SAFETY', image: 'ü¶∫' },
                { word: 'FRIEND', image: 'ü§ù' }, { word: 'BRAVE', image: 'ü¶Å' }, { word: 'HELPER', image: 'üôã' },
                { word: 'STRONG', image: 'üí™' }, { word: 'LEADER', image: 'üëë' }, { word: 'SHIELD', image: 'üõ°Ô∏è' },
                { word: 'FLYING', image: 'üöÅ' }, { word: 'MIGHTY', image: '‚ö°' }, { word: 'HEROES', image: 'ü¶∏‚Äç‚ôÇÔ∏è' }
            ]
        };

        // Reading stories by grade
        const readingStoriesByGrade = {
            kindergarten: [
                { story: '<span class="highlight-word">Heatwave</span> is a red fire truck. He helps put out fires!', question: 'What color is Heatwave?', choices: ['Red', 'Blue', 'Green'], answer: 0 },
                { story: '<span class="highlight-word">Blades</span> can fly in the sky. He is a helicopter!', question: 'What can Blades do?', choices: ['Swim', 'Fly', 'Dig'], answer: 1 },
                { story: 'Chase is a <span class="highlight-word">police</span> car. He keeps everyone safe!', question: 'What kind of car is Chase?', choices: ['Fire truck', 'Police car', 'Taxi'], answer: 1 },
                { story: 'Boulder is very <span class="highlight-word">strong</span>. He can lift heavy rocks!', question: 'What is Boulder?', choices: ['Weak', 'Small', 'Strong'], answer: 2 },
                { story: 'The Rescue Bots work as a <span class="highlight-word">team</span>. Together they save the day!', question: 'How do the Rescue Bots work?', choices: ['Alone', 'As a team', 'They sleep'], answer: 1 },
                { story: '<span class="highlight-word">Three</span> birds need help! The Rescue Bots fly to save them!', question: 'How many birds need help?', choices: ['One', 'Two', 'Three'], answer: 2 }
            ],
            grade1: [
                { story: 'Heatwave drove fast to the <span class="highlight-word">burning</span> building. He sprayed water on the fire. The flames went out. Everyone was safe!', question: 'What did Heatwave spray on the fire?', choices: ['Sand', 'Water', 'Foam'], answer: 1 },
                { story: 'Blades saw a cat stuck in a <span class="highlight-word">tall</span> tree. He flew up high and gently lifted the cat. The little girl was so happy to have her pet back!', question: 'Where was the cat stuck?', choices: ['On a roof', 'In a tree', 'In a cave'], answer: 1 },
                { story: 'Chase heard a <span class="highlight-word">loud</span> alarm at the bank. He raced over and found someone had dropped their bag. Chase returned the bag to its owner!', question: 'What did Chase find at the bank?', choices: ['A dropped bag', 'A thief', 'A broken door'], answer: 0 },
                { story: 'Boulder found huge <span class="highlight-word">rocks</span> blocking the road. Cars could not pass. He used his strong arms to move them. Now the road was clear!', question: 'Why could cars not pass?', choices: ['Too much rain', 'Rocks blocked the road', 'The bridge was broken'], answer: 1 },
                { story: 'The team got a call about a <span class="highlight-word">boat</span> in trouble. Blades flew over the water. Heatwave drove to the dock. Together they saved the sailors!', question: 'What was in trouble?', choices: ['A plane', 'A boat', 'A train'], answer: 1 },
                { story: 'It was a <span class="highlight-word">stormy</span> night on Griffin Rock. The power went out. The Rescue Bots helped people stay calm until the lights came back on.', question: 'What happened during the storm?', choices: ['A flood', 'The power went out', 'A fire started'], answer: 1 }
            ],
            grade2: [
                { story: 'Heatwave noticed smoke coming from the old warehouse. Before rushing in, he <span class="highlight-word">checked</span> if anyone was inside. He heard a faint cry for help and carefully rescued a family who had been trapped. His patience saved their lives.', question: 'Why was Heatwave\'s patience important?', choices: ['He needed to rest', 'It helped him find the trapped family', 'The fire was too hot'], answer: 1 },
                { story: 'Blades was nervous about flying in the heavy fog. Chase reminded him that his <span class="highlight-word">sensors</span> could help him see. Blades trusted his technology and successfully completed the rescue mission.', question: 'What does this story teach about facing fears?', choices: ['Avoid scary situations', 'Trust your abilities and tools', 'Wait for someone else to help'], answer: 1 },
                { story: 'Boulder accidentally broke a <span class="highlight-word">statue</span> while clearing rubble. He felt terrible and immediately told Chief Burns what happened. The Chief appreciated his honesty and they worked together to fix it.', question: 'Why was telling the truth important?', choices: ['To avoid punishment', 'It showed responsibility and helped solve the problem', 'The Chief already knew'], answer: 1 },
                { story: 'When a new bot arrived, some team members were <span class="highlight-word">unsure</span> about working with someone different. But they gave the new bot a chance and discovered amazing new skills that made the whole team stronger.', question: 'What is the main lesson of this story?', choices: ['New team members are always better', 'Being different can bring valuable new abilities', 'Old teams should stay the same'], answer: 1 },
                { story: 'During a difficult rescue, Heatwave wanted to act alone, but the mission was too <span class="highlight-word">complex</span>. When he asked his teammates for help, they succeeded together. Even the strongest need support sometimes.', question: 'What did Heatwave learn?', choices: ['He should always work alone', 'Asking for help shows strength, not weakness', 'His teammates were better than him'], answer: 1 },
                { story: 'Chase found a lost <span class="highlight-word">child</span> who spoke a different language. Even though they couldn\'t understand each other\'s words, Chase used kind gestures and a calm voice. The child felt safe and stopped crying.', question: 'How did Chase communicate without words?', choices: ['He used a translator machine', 'Through kindness, gestures, and a calm voice', 'He learned the new language quickly'], answer: 1 }
            ]
        };

        // Colors (same for all grades, but grade 2 adds color mixing)
        const colors = [
            { name: 'Red', color: '#e74c3c' }, { name: 'Blue', color: '#3498db' },
            { name: 'Green', color: '#2ecc71' }, { name: 'Yellow', color: '#f1c40f' },
            { name: 'Orange', color: '#e67e22' }, { name: 'Purple', color: '#9b59b6' },
            { name: 'Pink', color: '#fd79a8' }, { name: 'Brown', color: '#795548' }
        ];

        // Color mixing questions for grade 2
        const colorMixing = [
            { color1: 'Red', hex1: '#e74c3c', color2: 'Blue', hex2: '#3498db', result: 'Purple', hexResult: '#9b59b6' },
            { color1: 'Red', hex1: '#e74c3c', color2: 'Yellow', hex2: '#f1c40f', result: 'Orange', hexResult: '#e67e22' },
            { color1: 'Blue', hex1: '#3498db', color2: 'Yellow', hex2: '#f1c40f', result: 'Green', hexResult: '#2ecc71' },
            { color1: 'Red', hex1: '#e74c3c', color2: 'White', hex2: '#ffffff', result: 'Pink', hexResult: '#fd79a8' },
            { color1: 'Black', hex1: '#2c3e50', color2: 'White', hex2: '#ffffff', result: 'Gray', hexResult: '#95a5a6' }
        ];

        // Shapes by grade
        const shapesByGrade = {
            kindergarten: [
                { name: 'Circle', html: '<div class="shape circle"></div>' },
                { name: 'Square', html: '<div class="shape square"></div>' },
                { name: 'Triangle', html: '<div class="shape triangle"></div>' },
                { name: 'Rectangle', html: '<div class="shape rectangle"></div>' },
                { name: 'Star', html: '<div class="shape star">‚≠ê</div>' },
                { name: 'Heart', html: '<div class="shape heart">‚ù§Ô∏è</div>' }
            ],
            grade1: [
                { name: 'Circle', html: '<div class="shape circle"></div>' },
                { name: 'Square', html: '<div class="shape square"></div>' },
                { name: 'Triangle', html: '<div class="shape triangle"></div>' },
                { name: 'Rectangle', html: '<div class="shape rectangle"></div>' },
                { name: 'Star', html: '<div class="shape star">‚≠ê</div>' },
                { name: 'Heart', html: '<div class="shape heart">‚ù§Ô∏è</div>' },
                { name: 'Pentagon', html: '<div class="shape pentagon"></div>' },
                { name: 'Hexagon', html: '<div class="shape hexagon"></div>' },
                { name: 'Oval', html: '<div class="shape oval"></div>' },
                { name: 'Diamond', html: '<div class="shape diamond"></div>' }
            ],
            grade2: [
                { name: 'Circle', html: '<div class="shape circle"></div>' },
                { name: 'Square', html: '<div class="shape square"></div>' },
                { name: 'Triangle', html: '<div class="shape triangle"></div>' },
                { name: 'Rectangle', html: '<div class="shape rectangle"></div>' },
                { name: 'Pentagon', html: '<div class="shape pentagon"></div>' },
                { name: 'Hexagon', html: '<div class="shape hexagon"></div>' },
                { name: 'Oval', html: '<div class="shape oval"></div>' },
                { name: 'Diamond', html: '<div class="shape diamond"></div>' },
                { name: 'Cube', html: '<div class="shape cube"><div class="cube-face front"></div><div class="cube-face back"></div><div class="cube-face left"></div><div class="cube-face right"></div><div class="cube-face top"></div><div class="cube-face bottom"></div></div>' },
                { name: 'Sphere', html: '<div class="shape sphere"></div>' },
                { name: 'Cylinder', html: '<div class="shape cylinder"></div>' },
                { name: 'Cone', html: '<div class="shape cone"></div>' }
            ]
        };

        const countingItems = ['‚≠ê', 'ü§ñ', 'üöó', 'üîµ', '‚ù§Ô∏è', 'üåü', 'üéà', 'üçé'];

        // Full Story Mode Stories
        const storyModeStories = [
            {
                title: "The Big Storm",
                bot: "üöÅ",
                botName: "BLADES",
                chapters: [
                    {
                        text: "It was a dark and stormy night on Griffin Rock. The wind howled and rain poured down. Lightning flashed across the sky! Chief Burns got an emergency call - a family was trapped in their car on the flooded bridge!",
                        question: null
                    },
                    {
                        text: "'Rescue Bots, roll out!' called Chief Burns. Blades transformed into helicopter mode. He flew through the rain with Dani Burns inside. The storm was scary, but Blades was brave. He knew the family needed help!",
                        question: { text: "What did Blades transform into?", choices: ["A car", "A helicopter", "A boat"], answer: 1 }
                    },
                    {
                        text: "Blades found the car on the bridge. Water was rising fast! Dani lowered the rescue cable. One by one, Blades lifted each family member to safety - mom, dad, and two kids. They were so thankful!",
                        question: { text: "How many kids were in the family?", choices: ["One", "Two", "Three"], answer: 1 }
                    },
                    {
                        text: "Back at the firehouse, everyone was safe and dry. Chief Burns smiled at the team. 'Great work, Blades! You were very brave in that storm.' Blades felt proud. Helping others made all the danger worth it!",
                        question: { text: "How did Blades feel at the end?", choices: ["Scared", "Proud", "Tired"], answer: 1 }
                    }
                ]
            },
            {
                title: "Boulder Saves the Day",
                bot: "üöú",
                botName: "BOULDER",
                chapters: [
                    {
                        text: "Boulder loved learning about Earth. Today, he was helping at the construction site with Graham Burns. They were building a new playground for the children of Griffin Rock!",
                        question: null
                    },
                    {
                        text: "Suddenly, the ground started shaking! 'Earthquake!' yelled Graham. A big crack appeared, and part of the playground equipment started falling into a hole. Boulder acted fast - he used his strong arms to catch the slide!",
                        question: { text: "What natural disaster happened?", choices: ["Tornado", "Flood", "Earthquake"], answer: 2 }
                    },
                    {
                        text: "Boulder held the equipment steady while Graham helped the workers get to safety. His arms were getting tired, but he didn't give up. 'Almost there,' he told himself. Being strong wasn't just about muscles - it was about not giving up!",
                        question: { text: "What did Boulder learn about being strong?", choices: ["It's about muscles only", "It's about not giving up", "It's about being big"], answer: 1 }
                    },
                    {
                        text: "After the earthquake stopped, everyone cheered for Boulder. The playground was saved! Graham patted Boulder's arm. 'You're not just strong, Boulder. You're also very brave and kind.' Boulder smiled his biggest smile!",
                        question: { text: "Why did everyone cheer for Boulder?", choices: ["He finished building fast", "He saved the playground", "He found treasure"], answer: 1 }
                    }
                ]
            },
            {
                title: "Chase and the Missing Pet",
                bot: "üöî",
                botName: "CHASE",
                chapters: [
                    {
                        text: "Chase was the most careful and rule-following Rescue Bot. One day, a little girl named Emma came to the police station crying. Her puppy Biscuit had run away! Chief Burns asked Chase to help find him.",
                        question: null
                    },
                    {
                        text: "Chase used his police scanner to search for clues. He found tiny paw prints near the park! 'Evidence suggests the canine traveled this direction,' Chase reported. He followed the trail carefully, looking for more clues.",
                        question: { text: "Where did Chase find paw prints?", choices: ["At the beach", "Near the park", "By the school"], answer: 1 }
                    },
                    {
                        text: "The trail led to an old barn. Chase heard a small whimper coming from inside. There was Biscuit, stuck behind some hay bales! He was scared but okay. Chase gently moved the hay and picked up the little puppy.",
                        question: { text: "Where was Biscuit hiding?", choices: ["In a tree", "Under a car", "Behind hay bales"], answer: 2 }
                    },
                    {
                        text: "Emma was so happy when Chase brought Biscuit back! She gave the puppy a big hug. 'Thank you, Chase!' she said. Chase learned that being a good detective means paying attention to small details and never giving up!",
                        question: { text: "What did Chase learn about being a detective?", choices: ["Run fast", "Pay attention to details", "Be loud"], answer: 1 }
                    }
                ]
            },
            {
                title: "Heatwave's Hot Rescue",
                bot: "üöí",
                botName: "HEATWAVE",
                chapters: [
                    {
                        text: "Heatwave was the leader of the Rescue Bots. He was brave and strong, but sometimes he tried to do everything himself. Today, there was a big fire at the Griffin Rock bakery! Smoke filled the sky.",
                        question: null
                    },
                    {
                        text: "Heatwave rushed to the scene. The fire was huge! He started spraying water, but it wasn't enough. 'I need help,' Heatwave realized. He called his team. 'Rescue Bots, I need backup!' It was hard to ask for help, but Heatwave knew it was the right thing to do.",
                        question: { text: "What did Heatwave learn to do?", choices: ["Work alone", "Ask for help", "Give up"], answer: 1 }
                    },
                    {
                        text: "Boulder, Blades, and Chase all came to help. Boulder cleared away burning debris. Blades flew water from the bay. Chase kept people safe. Together, they put out the fire! The baker and his cat were saved!",
                        question: { text: "How did the team put out the fire?", choices: ["Heatwave did it alone", "They worked together", "They called the mayor"], answer: 1 }
                    },
                    {
                        text: "After the fire was out, the baker thanked all the Rescue Bots. Heatwave looked at his team proudly. 'We're stronger together,' he said. 'I'm lucky to have such a great team.' The other bots cheered!",
                        question: { text: "What did Heatwave learn about teamwork?", choices: ["It's not important", "They're stronger together", "One bot is enough"], answer: 1 }
                    }
                ]
            },
            {
                title: "The Bumblebee Visit",
                bot: "üöó",
                botName: "BUMBLEBEE",
                chapters: [
                    {
                        text: "One exciting day, Bumblebee came to visit Griffin Rock! The Rescue Bots were so happy to see their friend. Bumblebee had come from a far away place to teach them new rescue techniques.",
                        question: null
                    },
                    {
                        text: "Bumblebee showed the team how to work faster without making mistakes. 'Bzzz! Speed is good, but being careful is better!' he said. The Rescue Bots practiced the new moves over and over until they got them right.",
                        question: { text: "What did Bumblebee teach about speed?", choices: ["Speed is everything", "Being careful is better", "Go as fast as possible"], answer: 1 }
                    },
                    {
                        text: "That afternoon, there was a test! A ship was sinking in the harbor! The Rescue Bots used everything Bumblebee taught them. They moved fast AND carefully. They saved everyone on the ship!",
                        question: { text: "What was sinking in the harbor?", choices: ["A plane", "A ship", "A car"], answer: 1 }
                    },
                    {
                        text: "Bumblebee was so proud of the Rescue Bots. 'Bzzz! You learned so much!' Before he left, he gave each bot a special Autobot badge. 'You're all true heroes,' he said. The Rescue Bots would never forget this special visit!",
                        question: { text: "What did Bumblebee give each bot?", choices: ["A toy", "A badge", "A book"], answer: 1 }
                    }
                ]
            }
        ];

        // Grade selection function
        function selectGrade(grade) {
            playSound('click');
            currentGrade = grade;

            // Update button states
            document.querySelectorAll('.grade-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.grade-btn.${grade}`).classList.add('active');

            // Update display label
            document.getElementById('currentGradeLabel').textContent = gradeData[grade].label;
            document.getElementById('currentGradeLabel').style.color = gradeData[grade].color;

            // Save to localStorage
            saveGameState();
        }

        const audioContext = new (window.AudioContext || window.webkitAudioContext)();

        function playSound(type) {
            if (!soundEnabled) return;
            if (audioContext.state === 'suspended') audioContext.resume();

            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            if (type === 'correct') {
                oscillator.type = 'square';
                oscillator.frequency.setValueAtTime(400, audioContext.currentTime);
                oscillator.frequency.exponentialRampToValueAtTime(1200, audioContext.currentTime + 0.2);
                gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.3);
            } else if (type === 'wrong') {
                oscillator.type = 'sawtooth';
                oscillator.frequency.setValueAtTime(150, audioContext.currentTime);
                oscillator.frequency.exponentialRampToValueAtTime(100, audioContext.currentTime + 0.2);
                gainNode.gain.setValueAtTime(0.15, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.3);
            } else if (type === 'click') {
                oscillator.type = 'square';
                oscillator.frequency.setValueAtTime(600, audioContext.currentTime);
                oscillator.frequency.exponentialRampToValueAtTime(400, audioContext.currentTime + 0.05);
                gainNode.gain.setValueAtTime(0.15, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.1);
            } else if (type === 'transform') {
                oscillator.type = 'sawtooth';
                oscillator.frequency.setValueAtTime(200, audioContext.currentTime);
                oscillator.frequency.exponentialRampToValueAtTime(600, audioContext.currentTime + 0.3);
                oscillator.frequency.exponentialRampToValueAtTime(200, audioContext.currentTime + 0.6);
                oscillator.frequency.exponentialRampToValueAtTime(800, audioContext.currentTime + 0.9);
                gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 1);
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 1);
            } else if (type === 'celebrate') {
                [523.25, 659.25, 783.99, 1046.50].forEach((freq, i) => {
                    const osc = audioContext.createOscillator();
                    const gain = audioContext.createGain();
                    osc.connect(gain);
                    gain.connect(audioContext.destination);
                    osc.type = 'square';
                    osc.frequency.setValueAtTime(freq, audioContext.currentTime + i * 0.15);
                    gain.gain.setValueAtTime(0.15, audioContext.currentTime + i * 0.15);
                    gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + i * 0.15 + 0.3);
                    osc.start(audioContext.currentTime + i * 0.15);
                    osc.stop(audioContext.currentTime + i * 0.15 + 0.3);
                });
            } else if (type === 'unlock') {
                [261.63, 329.63, 392.00, 523.25, 659.25, 783.99].forEach((freq, i) => {
                    const osc = audioContext.createOscillator();
                    const gain = audioContext.createGain();
                    osc.connect(gain);
                    gain.connect(audioContext.destination);
                    osc.type = 'square';
                    osc.frequency.setValueAtTime(freq, audioContext.currentTime + i * 0.12);
                    gain.gain.setValueAtTime(0.2, audioContext.currentTime + i * 0.12);
                    gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + i * 0.12 + 0.4);
                    osc.start(audioContext.currentTime + i * 0.12);
                    osc.stop(audioContext.currentTime + i * 0.12 + 0.4);
                });
            }
        }

        function toggleSound() {
            soundEnabled = !soundEnabled;
            document.getElementById('soundToggle').textContent = soundEnabled ? 'üîä' : 'üîá';
        }

        function saveGameState() {
            localStorage.setItem('rescueBotsGame', JSON.stringify({
                totalScore, unlockedBots, currentGrade, ownedRewards,
                activeTheme, missionStats, totalEnergonEarned
            }));
        }

        function loadGameState() {
            const saved = localStorage.getItem('rescueBotsGame');
            if (saved) {
                const state = JSON.parse(saved);
                totalScore = state.totalScore || 0;
                unlockedBots = state.unlockedBots || { bumblebee: false, optimus: false, storymode: false };
                currentGrade = state.currentGrade || 'kindergarten';
                ownedRewards = state.ownedRewards || { powerups: [], themes: ['cyber'], badges: [] };
                activeTheme = state.activeTheme || 'cyber';
                missionStats = state.missionStats || { math: 0, spelling: 0, reading: 0, colors: 0, shapes: 0, counting: 0, story: 0 };
                totalEnergonEarned = state.totalEnergonEarned || 0;

                document.getElementById('totalScore').textContent = totalScore;
                updateUnlockUI();
                applyTheme(activeTheme);
                renderShop();
                checkBadges();

                // Restore grade selection UI
                document.querySelectorAll('.grade-btn').forEach(btn => btn.classList.remove('active'));
                document.querySelector(`.grade-btn.${currentGrade}`).classList.add('active');
                document.getElementById('currentGradeLabel').textContent = gradeData[currentGrade].label;
                document.getElementById('currentGradeLabel').style.color = gradeData[currentGrade].color;
            }
        }

        // Shop functions
        function toggleShop() {
            playSound('click');
            const shop = document.getElementById('shopSection');
            shop.classList.toggle('visible');
            renderShop();
        }

        function renderShop() {
            // Render powerups
            const powerupsGrid = document.getElementById('powerupsGrid');
            powerupsGrid.innerHTML = '';
            shopItems.powerups.forEach(item => {
                const owned = ownedRewards.powerups.includes(item.id);
                const card = document.createElement('div');
                card.className = `reward-card ${owned ? 'owned' : ''}`;
                card.innerHTML = `
                    <span class="reward-icon">${item.icon}</span>
                    <div class="reward-name">${item.name}</div>
                    <div class="reward-desc">${item.desc}</div>
                    ${!owned ? `<div class="reward-price"><span class="energon-icon"></span>${item.price}</div>` : ''}
                `;
                if (!owned) {
                    card.onclick = () => buyReward('powerups', item);
                } else {
                    card.onclick = () => usePowerup(item);
                }
                powerupsGrid.appendChild(card);
            });

            // Render themes
            const themesGrid = document.getElementById('themesGrid');
            themesGrid.innerHTML = '';
            shopItems.themes.forEach(item => {
                const owned = ownedRewards.themes.includes(item.id);
                const active = activeTheme === item.id;
                const card = document.createElement('div');
                card.className = `reward-card ${owned ? 'owned' : ''} ${active ? 'active-reward' : ''}`;
                card.innerHTML = `
                    <span class="reward-icon">${item.icon}</span>
                    <div class="reward-name">${item.name}</div>
                    <div class="reward-desc">${item.desc}</div>
                    <div class="theme-preview" style="background: linear-gradient(90deg, ${item.colors.join(', ')});"></div>
                    ${!owned && item.price > 0 ? `<div class="reward-price"><span class="energon-icon"></span>${item.price}</div>` : ''}
                `;
                if (!owned && item.price > 0) {
                    card.onclick = () => buyReward('themes', item);
                } else if (owned) {
                    card.onclick = () => activateTheme(item.id);
                }
                themesGrid.appendChild(card);
            });

            // Render badges
            const badgesGrid = document.getElementById('badgesGrid');
            badgesGrid.innerHTML = '';
            shopItems.badges.forEach(item => {
                const earned = ownedRewards.badges.includes(item.id);
                const card = document.createElement('div');
                card.className = `reward-card ${earned ? 'owned' : ''}`;
                card.style.opacity = earned ? '1' : '0.5';
                card.innerHTML = `
                    <span class="reward-icon">${item.icon}</span>
                    <div class="reward-name">${item.name}</div>
                    <div class="reward-desc">${item.desc}</div>
                `;
                badgesGrid.appendChild(card);
            });
        }

        function buyReward(type, item) {
            if (totalScore < item.price) {
                playSound('wrong');
                return;
            }

            playSound('unlock');
            totalScore -= item.price;
            ownedRewards[type].push(item.id);
            document.getElementById('totalScore').textContent = totalScore;
            saveGameState();
            renderShop();

            // Show unlock animation
            const unlockAnim = document.getElementById('unlockAnimation');
            document.getElementById('unlockBotIcon').textContent = item.icon;
            document.getElementById('unlockBotIcon').style.filter = 'none';
            document.getElementById('unlockBotName').textContent = item.name.toUpperCase();
            unlockAnim.classList.add('active');
            setTimeout(() => unlockAnim.classList.remove('active'), 2500);
        }

        function usePowerup(item) {
            playSound('correct');
            activePowerup = item.id;
            powerupEndTime = Date.now() + item.duration;

            const badge = document.getElementById('powerupBadge');
            badge.textContent = `‚ö° ${item.name.toUpperCase()} ACTIVE`;
            badge.classList.add('visible');

            setTimeout(() => {
                activePowerup = null;
                badge.classList.remove('visible');
            }, item.duration);
        }

        function activateTheme(themeId) {
            playSound('click');
            activeTheme = themeId;
            applyTheme(themeId);
            saveGameState();
            renderShop();
        }

        function applyTheme(themeId) {
            const theme = shopItems.themes.find(t => t.id === themeId);
            if (theme) {
                document.body.style.background = `linear-gradient(180deg, ${theme.colors[0]} 0%, ${theme.colors[1]} 50%, ${theme.colors[2]} 100%)`;
            }
        }

        function checkBadges() {
            shopItems.badges.forEach(badge => {
                if (ownedRewards.badges.includes(badge.id)) return;

                let earned = false;
                if (badge.requirement.type === 'missions') {
                    earned = missionStats[badge.requirement.game] >= badge.requirement.count;
                } else if (badge.requirement.type === 'score') {
                    earned = totalEnergonEarned >= badge.requirement.count;
                } else if (badge.requirement.type === 'unlockAll') {
                    earned = unlockedBots.bumblebee && unlockedBots.optimus && unlockedBots.storymode;
                }

                if (earned) {
                    ownedRewards.badges.push(badge.id);
                    saveGameState();

                    // Show badge earned animation
                    setTimeout(() => {
                        const unlockAnim = document.getElementById('unlockAnimation');
                        document.getElementById('unlockBotIcon').textContent = badge.icon;
                        document.getElementById('unlockBotIcon').style.filter = 'none';
                        document.getElementById('unlockBotName').textContent = 'BADGE EARNED: ' + badge.name.toUpperCase();
                        unlockAnim.classList.add('active');
                        setTimeout(() => unlockAnim.classList.remove('active'), 2500);
                    }, 1000);
                }
            });
        }

        function updateUnlockUI() {
            if (unlockedBots.bumblebee) {
                document.getElementById('bumblebeeLock').style.display = 'none';
                document.getElementById('bumblebeeCard').classList.remove('locked');
            } else {
                document.getElementById('bumblebeeUnlockBtn').disabled = totalScore < botPrices.bumblebee;
            }
            if (unlockedBots.optimus) {
                document.getElementById('optimusLock').style.display = 'none';
                document.getElementById('optimusCard').classList.remove('locked');
            } else {
                document.getElementById('optimusUnlockBtn').disabled = totalScore < botPrices.optimus;
            }
            if (unlockedBots.bumblebee && unlockedBots.optimus) {
                document.getElementById('lockedTitle').textContent = '‚≠ê LEGENDARY AUTOBOTS ‚≠ê';
                document.getElementById('lockedTitle').classList.remove('locked-section');
            }

            // Story mode unlock
            if (unlockedBots.storymode) {
                document.getElementById('storymodeLock').style.display = 'none';
                document.getElementById('storyCard').classList.remove('locked');
                document.getElementById('storyTitle').textContent = 'üìñ STORY MODE üìñ';
                document.getElementById('storyTitle').classList.remove('locked-section');
            } else {
                document.getElementById('storymodeUnlockBtn').disabled = totalScore < botPrices.storymode;
            }
        }

        function showShopHint() {
            playSound('click');
            document.getElementById('lockedTitle').scrollIntoView({ behavior: 'smooth' });
        }

        function handleLockedClick(bot) {
            if (unlockedBots[bot]) {
                if (bot === 'bumblebee') startGame('shapes');
                else if (bot === 'optimus') startGame('counting');
                else if (bot === 'storymode') startStoryMode();
            }
        }

        function unlockBot(bot, price) {
            if (totalScore >= price && !unlockedBots[bot]) {
                totalScore -= price;
                unlockedBots[bot] = true;
                document.getElementById('totalScore').textContent = totalScore;
                saveGameState();

                const unlockAnim = document.getElementById('unlockAnimation');
                let icon, name, filter = 'none';

                if (bot === 'bumblebee') {
                    icon = 'üöó';
                    name = 'BUMBLEBEE';
                    filter = 'hue-rotate(40deg) saturate(1.5) brightness(1.2)';
                } else if (bot === 'optimus') {
                    icon = 'üöõ';
                    name = 'OPTIMUS PRIME';
                } else if (bot === 'storymode') {
                    icon = 'üìö';
                    name = 'STORY MODE';
                }

                document.getElementById('unlockBotIcon').textContent = icon;
                document.getElementById('unlockBotIcon').style.filter = filter;
                document.getElementById('unlockBotName').textContent = name;

                playSound('unlock');
                unlockAnim.classList.add('active');
                setTimeout(() => {
                    unlockAnim.classList.remove('active');
                    updateUnlockUI();
                    checkBadges();
                }, 3000);
            }
        }

        function createEnergonParticles() {
            const container = document.getElementById('energonParticles');
            for (let i = 0; i < 15; i++) {
                const particle = document.createElement('div');
                particle.className = 'energon-particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.animationDelay = Math.random() * 8 + 's';
                particle.style.animationDuration = (6 + Math.random() * 4) + 's';
                container.appendChild(particle);
            }
        }

        function showTransformAnimation(game, callback) {
            const bot = botData[game];
            const overlay = document.getElementById('transformOverlay');
            const vehicleForm = document.getElementById('vehicleForm');
            const robotForm = document.getElementById('robotForm');
            const textOverlay = document.getElementById('transformTextOverlay');
            const botName = document.getElementById('botNameTransform');
            const sparksDiv = document.getElementById('transformSparks');

            // Set vehicle and robot
            vehicleForm.textContent = bot.vehicle;
            vehicleForm.style.filter = bot.isYellow ? 'hue-rotate(40deg) saturate(1.5) brightness(1.2)' : 'none';
            robotForm.textContent = bot.robot;
            botName.textContent = bot.name;
            botName.style.color = bot.color;

            // Reset animations
            vehicleForm.classList.remove('transforming');
            robotForm.classList.remove('transforming');
            textOverlay.classList.remove('show');
            botName.classList.remove('show');
            sparksDiv.innerHTML = '';

            // Show overlay
            overlay.classList.add('active');
            playSound('transform');

            // Create sparks
            setTimeout(() => {
                for (let i = 0; i < 20; i++) {
                    const spark = document.createElement('div');
                    spark.className = 'spark';
                    const angle = (i / 20) * Math.PI * 2;
                    const distance = 100 + Math.random() * 100;
                    spark.style.setProperty('--tx', Math.cos(angle) * distance + 'px');
                    spark.style.setProperty('--ty', Math.sin(angle) * distance + 'px');
                    spark.style.background = bot.color;
                    spark.style.boxShadow = `0 0 10px ${bot.color}`;
                    sparksDiv.appendChild(spark);
                    setTimeout(() => spark.classList.add('transforming'), 10);
                }
            }, 400);

            // Start animations
            setTimeout(() => {
                vehicleForm.classList.add('transforming');
                robotForm.classList.add('transforming');
                textOverlay.classList.add('show');
                botName.classList.add('show');
            }, 100);

            // Hide and callback
            setTimeout(() => {
                overlay.classList.remove('active');
                if (callback) callback();
            }, 2500);
        }

        function startGame(game) {
            playSound('click');
            currentGame = game;

            showTransformAnimation(game, () => {
                document.getElementById('mainMenu').style.display = 'none';
                document.getElementById('lockedMenu').style.display = 'none';
                document.getElementById('lockedTitle').style.display = 'none';
                document.getElementById('storyTitle').style.display = 'none';
                document.getElementById('storyMenu').style.display = 'none';
                document.getElementById('shopToggle').style.display = 'none';
                document.getElementById('shopSection').classList.remove('visible');
                document.querySelector('.section-title:not(.locked-section)').style.display = 'none';

                const screens = { math: 'mathScreen', spelling: 'spellingScreen', reading: 'readingScreen', colors: 'colorsScreen', shapes: 'shapesScreen', counting: 'countingScreen' };
                const initFuncs = { math: () => { mathProblemCount = 0; generateMathProblem(); }, spelling: () => { spellingWordCount = 0; generateSpellingWord(); }, reading: () => { readingStoryCount = 0; generateReadingStory(); }, colors: () => { colorsQuestionCount = 0; generateColorQuestion(); }, shapes: () => { shapesQuestionCount = 0; generateShapeQuestion(); }, counting: () => { countingQuestionCount = 0; generateCountingQuestion(); } };

                document.getElementById(screens[game]).classList.add('active');
                initFuncs[game]();
            });
        }

        function goBack() {
            playSound('click');
            document.querySelectorAll('.game-screen').forEach(s => s.classList.remove('active'));
            document.getElementById('mainMenu').style.display = 'grid';
            document.getElementById('lockedMenu').style.display = 'grid';
            document.getElementById('lockedTitle').style.display = 'block';
            document.getElementById('storyTitle').style.display = 'block';
            document.getElementById('storyMenu').style.display = 'grid';
            document.getElementById('shopToggle').style.display = 'block';
            document.querySelector('.section-title:not(.locked-section)').style.display = 'block';
        }

        function updateScore(points) {
            // Apply double energon powerup if active
            const actualPoints = activePowerup === 'double_energon' ? points * 2 : points;
            totalScore += actualPoints;
            totalEnergonEarned += actualPoints;
            document.getElementById('totalScore').textContent = totalScore;
            updateUnlockUI();
            checkBadges();
            saveGameState();
        }

        function showCelebration(bot, message, botName, energonReward) {
            playSound('celebrate');

            // Track mission completion
            if (currentGame && missionStats.hasOwnProperty(currentGame)) {
                missionStats[currentGame]++;
            }

            const celebration = document.getElementById('celebration');
            document.getElementById('celebrationBot').textContent = bot;
            document.getElementById('celebrationMessage').textContent = `${botName} says: ${message}`;

            // Show double if powerup active
            const displayReward = activePowerup === 'double_energon' ? energonReward * 2 : energonReward;
            document.getElementById('energonEarned').textContent = `+${displayReward} ENERGON!${activePowerup === 'double_energon' ? ' (2X BONUS!)' : ''}`;
            celebration.classList.add('active');
            updateScore(energonReward);

            for (let i = 0; i < 20; i++) {
                const burst = document.createElement('div');
                burst.className = 'energon-burst';
                const angle = (i / 20) * Math.PI * 2;
                const distance = 150 + Math.random() * 100;
                burst.style.setProperty('--x', Math.cos(angle) * distance + 'px');
                burst.style.setProperty('--y', Math.sin(angle) * distance + 'px');
                burst.style.left = '50%';
                burst.style.top = '50%';
                celebration.appendChild(burst);
            }

            setTimeout(() => {
                celebration.classList.remove('active');
                celebration.querySelectorAll('.energon-burst').forEach(b => b.remove());
            }, 3000);
        }

        // Math Game
        function generateMathProblem() {
            let num1, num2, answer, problemText, operation;

            if (currentGrade === 'kindergarten') {
                // Addition 1-5 + 1-5 (max sum: 10)
                num1 = Math.floor(Math.random() * 5) + 1;
                num2 = Math.floor(Math.random() * 5) + 1;
                answer = num1 + num2;
                problemText = `${num1} + ${num2} = ?`;
                operation = 'add';
            } else if (currentGrade === 'grade1') {
                // Addition 1-10 + 1-10, or subtraction
                const useSubtraction = Math.random() < 0.4;
                if (useSubtraction) {
                    num1 = Math.floor(Math.random() * 15) + 5; // 5-19
                    num2 = Math.floor(Math.random() * Math.min(num1, 10)) + 1; // ensure positive result
                    answer = num1 - num2;
                    problemText = `${num1} - ${num2} = ?`;
                    operation = 'subtract';
                } else {
                    num1 = Math.floor(Math.random() * 10) + 1;
                    num2 = Math.floor(Math.random() * 10) + 1;
                    answer = num1 + num2;
                    problemText = `${num1} + ${num2} = ?`;
                    operation = 'add';
                }
            } else { // grade2
                // Addition/subtraction to 20, simple multiplication (2x, 5x, 10x)
                const problemType = Math.random();
                if (problemType < 0.35) {
                    // Addition
                    num1 = Math.floor(Math.random() * 15) + 1;
                    num2 = Math.floor(Math.random() * (20 - num1)) + 1;
                    answer = num1 + num2;
                    problemText = `${num1} + ${num2} = ?`;
                    operation = 'add';
                } else if (problemType < 0.65) {
                    // Subtraction
                    num1 = Math.floor(Math.random() * 15) + 5;
                    num2 = Math.floor(Math.random() * Math.min(num1, 15)) + 1;
                    answer = num1 - num2;
                    problemText = `${num1} - ${num2} = ?`;
                    operation = 'subtract';
                } else {
                    // Multiplication (2x, 5x, or 10x tables)
                    const multipliers = [2, 5, 10];
                    num1 = multipliers[Math.floor(Math.random() * multipliers.length)];
                    num2 = Math.floor(Math.random() * 10) + 1;
                    answer = num1 * num2;
                    problemText = `${num1} √ó ${num2} = ?`;
                    operation = 'multiply';
                }
            }

            currentMathProblem = { num1, num2, answer, operation };
            document.getElementById('mathProblem').textContent = problemText;
            document.getElementById('mathProgress').style.width = (mathProblemCount / 5 * 100) + '%';
            document.getElementById('mathCount').textContent = mathProblemCount;
            document.getElementById('mathNext').classList.remove('visible');

            // Generate wrong answers based on the operation
            let choices = [answer];
            const maxWrong = currentGrade === 'kindergarten' ? 15 : (currentGrade === 'grade1' ? 25 : 100);
            while (choices.length < 4) {
                let wrong;
                if (operation === 'multiply') {
                    wrong = Math.floor(Math.random() * 50) + 1;
                } else {
                    wrong = Math.floor(Math.random() * maxWrong) + 1;
                }
                if (!choices.includes(wrong) && wrong !== answer) choices.push(wrong);
            }
            choices.sort(() => Math.random() - 0.5);

            const answersDiv = document.getElementById('mathAnswers');
            answersDiv.innerHTML = '';
            choices.forEach(choice => {
                const btn = document.createElement('button');
                btn.className = 'answer-btn';
                btn.textContent = choice;
                btn.onclick = () => checkMathAnswer(btn, choice);
                answersDiv.appendChild(btn);
            });

            const speechMessages = {
                add: `Steven! Emergency! Calculate ${num1} + ${num2} to rescue!`,
                subtract: `Steven! Quick thinking! What is ${num1} - ${num2}?`,
                multiply: `Steven! Power calculation! What is ${num1} √ó ${num2}?`
            };
            document.getElementById('mathSpeech').textContent = speechMessages[operation];
        }

        function checkMathAnswer(btn, choice) {
            if (btn.classList.contains('correct') || btn.classList.contains('wrong')) return;
            const buttons = document.querySelectorAll('#mathAnswers .answer-btn');
            if (choice === currentMathProblem.answer) {
                playSound('correct');
                btn.classList.add('correct');
                updateScore(10);
                mathProblemCount++;
                document.getElementById('mathSpeech').textContent = "Rescue successful! Outstanding work, Steven!";
                document.getElementById('mathProgress').style.width = (mathProblemCount / 5 * 100) + '%';
                document.getElementById('mathCount').textContent = mathProblemCount;
                buttons.forEach(b => b.style.pointerEvents = 'none');
                if (mathProblemCount >= 5) { showCelebration('ü§ñ', "Steven, you're a true Rescue Bot hero!", "HEATWAVE", 25); setTimeout(goBack, 3500); }
                else document.getElementById('mathNext').classList.add('visible');
            } else {
                playSound('wrong');
                btn.classList.add('wrong');
                document.getElementById('mathSpeech').textContent = "Recalculating... Try again, Steven!";
            }
        }

        function nextMathProblem() { playSound('click'); generateMathProblem(); }

        // Spelling Game
        function generateSpellingWord() {
            const wordList = spellingWordsByGrade[currentGrade];
            const wordData = wordList[Math.floor(Math.random() * wordList.length)];
            currentWord = wordData.word;
            currentLetterIndex = 0;
            document.getElementById('wordImage').textContent = wordData.image;
            document.getElementById('spellingProgress').style.width = (spellingWordCount / 5 * 100) + '%';
            document.getElementById('spellingCount').textContent = spellingWordCount;
            document.getElementById('spellingNext').classList.remove('visible');

            const slotsDiv = document.getElementById('letterSlots');
            slotsDiv.innerHTML = '';
            for (let i = 0; i < currentWord.length; i++) {
                const slot = document.createElement('div');
                slot.className = 'letter-slot';
                slot.id = `slot-${i}`;
                slotsDiv.appendChild(slot);
            }

            let letters = currentWord.split('');
            const extraLetters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('');
            // More letters for harder words
            const targetLetterCount = currentGrade === 'kindergarten' ? 6 : (currentGrade === 'grade1' ? 8 : 10);
            while (letters.length < targetLetterCount) {
                const randomLetter = extraLetters[Math.floor(Math.random() * extraLetters.length)];
                if (!letters.includes(randomLetter)) letters.push(randomLetter);
            }
            letters.sort(() => Math.random() - 0.5);

            const choicesDiv = document.getElementById('letterChoices');
            choicesDiv.innerHTML = '';
            letters.forEach((letter, index) => {
                const btn = document.createElement('button');
                btn.className = 'letter-btn';
                btn.textContent = letter;
                btn.id = `letter-${index}`;
                btn.onclick = () => selectLetter(btn, letter);
                choicesDiv.appendChild(btn);
            });

            const gradeMessages = {
                kindergarten: "Steven! Target acquired! Spell the word to proceed!",
                grade1: "Steven! Aerial scan complete! Spell this rescue word!",
                grade2: "Steven! Advanced mission! Spell this challenging word!"
            };
            document.getElementById('spellingSpeech').textContent = gradeMessages[currentGrade];
        }

        function selectLetter(btn, letter) {
            if (btn.classList.contains('used')) return;
            if (letter === currentWord[currentLetterIndex]) {
                playSound('correct');
                btn.classList.add('used');
                const slot = document.getElementById(`slot-${currentLetterIndex}`);
                slot.textContent = letter;
                slot.classList.add('filled');
                currentLetterIndex++;
                if (currentLetterIndex >= currentWord.length) {
                    updateScore(15);
                    spellingWordCount++;
                    document.getElementById('spellingSpeech').textContent = `Word decoded: ${currentWord}! Mission success!`;
                    document.getElementById('spellingProgress').style.width = (spellingWordCount / 5 * 100) + '%';
                    document.getElementById('spellingCount').textContent = spellingWordCount;
                    if (spellingWordCount >= 5) { showCelebration('ü§ñ', "Steven, your spelling skills are sky-high!", "BLADES", 25); setTimeout(goBack, 3500); }
                    else document.getElementById('spellingNext').classList.add('visible');
                }
            } else {
                playSound('wrong');
                btn.style.animation = 'wrongShake 0.5s ease';
                setTimeout(() => btn.style.animation = '', 500);
                document.getElementById('spellingSpeech').textContent = "Letter mismatch! Scan again, Steven!";
            }
        }

        function nextSpellingWord() { playSound('click'); generateSpellingWord(); }

        // Reading Game
        function generateReadingStory() {
            const storyList = readingStoriesByGrade[currentGrade];
            currentStory = storyList[Math.floor(Math.random() * storyList.length)];
            document.getElementById('storyText').innerHTML = currentStory.story;
            document.getElementById('readingQuestion').textContent = currentStory.question;
            document.getElementById('readingProgress').style.width = (readingStoryCount / 5 * 100) + '%';
            document.getElementById('readingCount').textContent = readingStoryCount;
            document.getElementById('readingNext').classList.remove('visible');

            const choicesDiv = document.getElementById('readingChoices');
            choicesDiv.innerHTML = '';
            currentStory.choices.forEach((choice, index) => {
                const btn = document.createElement('button');
                btn.className = 'reading-choice';
                btn.textContent = choice;
                btn.onclick = () => checkReadingAnswer(btn, index);
                choicesDiv.appendChild(btn);
            });

            const gradeMessages = {
                kindergarten: "Steven! Incoming report! Analyze and respond!",
                grade1: "Steven! Read the full report and solve the case!",
                grade2: "Steven! This case requires careful analysis. Think about what the story means!"
            };
            document.getElementById('readingSpeech').textContent = gradeMessages[currentGrade];
        }

        function checkReadingAnswer(btn, index) {
            const buttons = document.querySelectorAll('#readingChoices .reading-choice');
            if (index === currentStory.answer) {
                playSound('correct');
                btn.classList.add('correct');
                updateScore(15);
                readingStoryCount++;
                document.getElementById('readingSpeech').textContent = "Case solved! Excellent detective work!";
                document.getElementById('readingProgress').style.width = (readingStoryCount / 5 * 100) + '%';
                document.getElementById('readingCount').textContent = readingStoryCount;
                buttons.forEach(b => b.style.pointerEvents = 'none');
                if (readingStoryCount >= 5) { showCelebration('ü§ñ', "Steven, you read like a champion!", "CHASE", 25); setTimeout(goBack, 3500); }
                else document.getElementById('readingNext').classList.add('visible');
            } else {
                playSound('wrong');
                btn.classList.add('wrong');
                document.getElementById('readingSpeech').textContent = "Re-read the evidence, Steven! Try again!";
            }
        }

        function nextReadingStory() { playSound('click'); generateReadingStory(); }

        // Colors Game
        function generateColorQuestion() {
            currentColorMix = null;

            // Grade 2 has a chance for color mixing questions
            if (currentGrade === 'grade2' && Math.random() < 0.5) {
                // Color mixing question
                currentColorMix = colorMixing[Math.floor(Math.random() * colorMixing.length)];
                currentColor = { name: currentColorMix.result, color: currentColorMix.hexResult };

                // Create color mixing display
                const displayDiv = document.getElementById('colorDisplay');
                displayDiv.style.background = 'transparent';
                displayDiv.innerHTML = `
                    <div class="color-mix-display">
                        <div class="color-mix-box" style="background: ${currentColorMix.hex1};"></div>
                        <span class="color-mix-plus">+</span>
                        <div class="color-mix-box" style="background: ${currentColorMix.hex2};"></div>
                        <span class="color-mix-equals">=</span>
                        <div class="color-mix-result">?</div>
                    </div>
                `;

                let choices = [currentColorMix.result];
                const allColorNames = colors.map(c => c.name).concat(['Gray']);
                while (choices.length < 4) {
                    const randomColor = allColorNames[Math.floor(Math.random() * allColorNames.length)];
                    if (!choices.includes(randomColor)) choices.push(randomColor);
                }
                choices.sort(() => Math.random() - 0.5);

                const choicesDiv = document.getElementById('colorChoices');
                choicesDiv.innerHTML = '';
                choices.forEach(choice => {
                    const btn = document.createElement('button');
                    btn.className = 'color-btn';
                    btn.textContent = choice;
                    btn.onclick = () => checkColorAnswer(btn, choice);
                    choicesDiv.appendChild(btn);
                });
                document.getElementById('colorsSpeech').textContent = `Steven! Color science! What color do ${currentColorMix.color1} and ${currentColorMix.color2} make?`;
            } else {
                // Regular color identification
                currentColor = colors[Math.floor(Math.random() * colors.length)];
                const displayDiv = document.getElementById('colorDisplay');
                displayDiv.innerHTML = '';
                displayDiv.style.background = currentColor.color;

                let choices = [currentColor.name];
                while (choices.length < 4) {
                    const randomColor = colors[Math.floor(Math.random() * colors.length)].name;
                    if (!choices.includes(randomColor)) choices.push(randomColor);
                }
                choices.sort(() => Math.random() - 0.5);

                const choicesDiv = document.getElementById('colorChoices');
                choicesDiv.innerHTML = '';
                choices.forEach(choice => {
                    const btn = document.createElement('button');
                    btn.className = 'color-btn';
                    btn.textContent = choice;
                    btn.onclick = () => checkColorAnswer(btn, choice);
                    choicesDiv.appendChild(btn);
                });
                document.getElementById('colorsSpeech').textContent = "Steven! Construction site scan! Identify this color!";
            }

            document.getElementById('colorsProgress').style.width = (colorsQuestionCount / 5 * 100) + '%';
            document.getElementById('colorsCount').textContent = colorsQuestionCount;
            document.getElementById('colorsNext').classList.remove('visible');
        }

        function checkColorAnswer(btn, choice) {
            const buttons = document.querySelectorAll('#colorChoices .color-btn');
            if (choice === currentColor.name) {
                playSound('correct');
                btn.classList.add('correct');
                updateScore(10);
                colorsQuestionCount++;
                document.getElementById('colorsSpeech').textContent = `Correct! That's ${currentColor.name}! Great building!`;
                document.getElementById('colorsProgress').style.width = (colorsQuestionCount / 5 * 100) + '%';
                document.getElementById('colorsCount').textContent = colorsQuestionCount;
                buttons.forEach(b => b.style.pointerEvents = 'none');
                if (colorsQuestionCount >= 5) { showCelebration('ü§ñ', "Steven, you know colors like a pro builder!", "BOULDER", 25); setTimeout(goBack, 3500); }
                else document.getElementById('colorsNext').classList.add('visible');
            } else {
                playSound('wrong');
                btn.classList.add('wrong');
                document.getElementById('colorsSpeech').textContent = "Color scan error! Try again, Steven!";
            }
        }

        function nextColorQuestion() { playSound('click'); generateColorQuestion(); }

        // Shapes Game (Bumblebee)
        function generateShapeQuestion() {
            const shapeList = shapesByGrade[currentGrade];
            currentShape = shapeList[Math.floor(Math.random() * shapeList.length)];
            document.getElementById('shapeDisplay').innerHTML = currentShape.html;
            document.getElementById('shapesProgress').style.width = (shapesQuestionCount / 5 * 100) + '%';
            document.getElementById('shapesCount').textContent = shapesQuestionCount;
            document.getElementById('shapesNext').classList.remove('visible');

            let choices = [currentShape.name];
            while (choices.length < 4) {
                const randomShape = shapeList[Math.floor(Math.random() * shapeList.length)].name;
                if (!choices.includes(randomShape)) choices.push(randomShape);
            }
            choices.sort(() => Math.random() - 0.5);

            const choicesDiv = document.getElementById('shapeChoices');
            choicesDiv.innerHTML = '';
            choices.forEach(choice => {
                const btn = document.createElement('button');
                btn.className = 'shape-btn';
                btn.textContent = choice;
                btn.onclick = () => checkShapeAnswer(btn, choice);
                choicesDiv.appendChild(btn);
            });

            const is3D = ['Cube', 'Sphere', 'Cylinder', 'Cone'].includes(currentShape.name);
            const gradeMessages = {
                kindergarten: "Bzzz! Steven, what shape is this?",
                grade1: "Bzzz! Shape scout mission! Can you identify this shape?",
                grade2: is3D ? "Bzzz! 3D shape detected! What is this solid shape called?" : "Bzzz! Advanced shape recognition! What shape is this?"
            };
            document.getElementById('shapesSpeech').textContent = gradeMessages[currentGrade];
        }

        function checkShapeAnswer(btn, choice) {
            const buttons = document.querySelectorAll('#shapeChoices .shape-btn');
            if (choice === currentShape.name) {
                playSound('correct');
                btn.classList.add('correct');
                updateScore(12);
                shapesQuestionCount++;
                document.getElementById('shapesSpeech').textContent = `Bzzz! That's a ${currentShape.name}! You're amazing, Steven!`;
                document.getElementById('shapesProgress').style.width = (shapesQuestionCount / 5 * 100) + '%';
                document.getElementById('shapesCount').textContent = shapesQuestionCount;
                buttons.forEach(b => b.style.pointerEvents = 'none');
                if (shapesQuestionCount >= 5) { showCelebration('ü§ñ', "Steven, you're a shape master! Bzzz!", "BUMBLEBEE", 30); setTimeout(goBack, 3500); }
                else document.getElementById('shapesNext').classList.add('visible');
            } else {
                playSound('wrong');
                btn.classList.add('wrong');
                document.getElementById('shapesSpeech').textContent = "Bzzz! Look again, Steven! You can do it!";
            }
        }

        function nextShapeQuestion() { playSound('click'); generateShapeQuestion(); }

        // Counting Game (Optimus Prime)
        function generateCountingQuestion() {
            const item = countingItems[Math.floor(Math.random() * countingItems.length)];
            const displayDiv = document.getElementById('countingDisplay');
            displayDiv.innerHTML = '';
            currentCountType = 'normal';

            // Grade 2 can have skip counting
            if (currentGrade === 'grade2' && Math.random() < 0.4) {
                // Skip counting question
                const skipTypes = [2, 5, 10];
                const skipBy = skipTypes[Math.floor(Math.random() * skipTypes.length)];
                const startNum = skipBy === 10 ? 10 : (skipBy === 5 ? 5 : 2);
                const numItems = Math.floor(Math.random() * 4) + 3; // 3-6 items
                currentCount = startNum + (numItems - 1) * skipBy; // Answer is the last number

                currentCountType = 'skip';

                // Show the sequence with the last one as ?
                let sequenceHtml = '';
                for (let i = 0; i < numItems; i++) {
                    const num = startNum + i * skipBy;
                    if (i === numItems - 1) {
                        sequenceHtml += `<span class="counting-item" style="font-size: 40px; animation-delay: ${i * 0.1}s">?</span>`;
                    } else {
                        sequenceHtml += `<span class="counting-item" style="font-size: 40px; animation-delay: ${i * 0.1}s">${num}</span>`;
                    }
                }
                displayDiv.innerHTML = sequenceHtml;
                document.getElementById('countingQuestion').textContent = `Skip counting by ${skipBy}s! What comes next?`;
                document.getElementById('countingSpeech').textContent = `Steven! Pattern detected! Count by ${skipBy}s to find the next number!`;

                let choices = [currentCount];
                while (choices.length < 4) {
                    const wrong = currentCount + (Math.floor(Math.random() * 5) - 2) * skipBy;
                    if (!choices.includes(wrong) && wrong > 0 && wrong !== currentCount) choices.push(wrong);
                }
                // Ensure we have 4 choices
                while (choices.length < 4) {
                    const wrong = Math.floor(Math.random() * 50) + 10;
                    if (!choices.includes(wrong)) choices.push(wrong);
                }
                choices.sort(() => Math.random() - 0.5);

                const choicesDiv = document.getElementById('countingChoices');
                choicesDiv.innerHTML = '';
                choices.forEach(choice => {
                    const btn = document.createElement('button');
                    btn.className = 'counting-btn';
                    btn.textContent = choice;
                    btn.onclick = () => checkCountingAnswer(btn, choice);
                    choicesDiv.appendChild(btn);
                });
            } else {
                // Regular counting
                let maxCount;
                if (currentGrade === 'kindergarten') {
                    maxCount = 8;
                } else if (currentGrade === 'grade1') {
                    maxCount = 15;
                } else {
                    maxCount = 20;
                }
                currentCount = Math.floor(Math.random() * maxCount) + 1;

                for (let i = 0; i < currentCount; i++) {
                    const itemSpan = document.createElement('span');
                    itemSpan.className = 'counting-item';
                    itemSpan.textContent = item;
                    itemSpan.style.animationDelay = (i * 0.1) + 's';
                    displayDiv.appendChild(itemSpan);
                }
                document.getElementById('countingQuestion').textContent = `How many ${item} do you see?`;

                let choices = [currentCount];
                const wrongRange = currentGrade === 'kindergarten' ? 10 : (currentGrade === 'grade1' ? 18 : 25);
                while (choices.length < 4) {
                    const wrong = Math.floor(Math.random() * wrongRange) + 1;
                    if (!choices.includes(wrong)) choices.push(wrong);
                }
                choices.sort(() => Math.random() - 0.5);

                const choicesDiv = document.getElementById('countingChoices');
                choicesDiv.innerHTML = '';
                choices.forEach(choice => {
                    const btn = document.createElement('button');
                    btn.className = 'counting-btn';
                    btn.textContent = choice;
                    btn.onclick = () => checkCountingAnswer(btn, choice);
                    choicesDiv.appendChild(btn);
                });
                document.getElementById('countingSpeech').textContent = "Steven! Autobots, count with me! How many do you see?";
            }

            document.getElementById('countingProgress').style.width = (countingQuestionCount / 5 * 100) + '%';
            document.getElementById('countingCount').textContent = countingQuestionCount;
            document.getElementById('countingNext').classList.remove('visible');
        }

        function checkCountingAnswer(btn, choice) {
            const buttons = document.querySelectorAll('#countingChoices .counting-btn');
            if (choice === currentCount) {
                playSound('correct');
                btn.classList.add('correct');
                updateScore(12);
                countingQuestionCount++;
                document.getElementById('countingSpeech').textContent = `Outstanding, Steven! There are ${currentCount}! Well done!`;
                document.getElementById('countingProgress').style.width = (countingQuestionCount / 5 * 100) + '%';
                document.getElementById('countingCount').textContent = countingQuestionCount;
                buttons.forEach(b => b.style.pointerEvents = 'none');
                if (countingQuestionCount >= 5) { showCelebration('ü§ñ', "Steven, you count like a true leader!", "OPTIMUS PRIME", 40); setTimeout(goBack, 3500); }
                else document.getElementById('countingNext').classList.add('visible');
            } else {
                playSound('wrong');
                btn.classList.add('wrong');
                document.getElementById('countingSpeech').textContent = "Count again carefully, Steven. You can do this!";
            }
        }

        function nextCountingQuestion() { playSound('click'); generateCountingQuestion(); }

        // Story Mode Functions
        function startStoryMode() {
            playSound('click');
            currentGame = 'story';

            // Pick a random story
            currentStoryData = storyModeStories[Math.floor(Math.random() * storyModeStories.length)];
            currentStoryChapter = 0;
            currentStoryPart = 0;
            storyQuestionAnswered = false;

            showTransformAnimation('reading', () => {
                document.getElementById('mainMenu').style.display = 'none';
                document.getElementById('lockedMenu').style.display = 'none';
                document.getElementById('lockedTitle').style.display = 'none';
                document.getElementById('storyTitle').style.display = 'none';
                document.getElementById('storyMenu').style.display = 'none';
                document.querySelector('.section-title:not(.locked-section)').style.display = 'none';
                document.getElementById('shopToggle').style.display = 'none';
                document.getElementById('shopSection').classList.remove('visible');

                document.getElementById('storyScreen').classList.add('active');
                document.getElementById('storyTotalChapters').textContent = currentStoryData.chapters.length;
                document.getElementById('storyTitle2').textContent = currentStoryData.title;
                document.getElementById('storyBotAvatar').textContent = currentStoryData.bot;

                loadStoryChapter();
            });
        }

        function loadStoryChapter() {
            const chapter = currentStoryData.chapters[currentStoryChapter];
            document.getElementById('storyChapter').textContent = currentStoryChapter + 1;
            document.getElementById('storyProgress').style.width = ((currentStoryChapter + 1) / currentStoryData.chapters.length * 100) + '%';
            document.getElementById('storyFullText').innerHTML = chapter.text;
            document.getElementById('storySpeech').textContent = `${currentStoryData.botName} is telling the story...`;

            // Reset question section
            document.getElementById('storyQuestionSection').style.display = 'none';
            document.getElementById('storyContinue').style.display = 'block';
            document.getElementById('storyNext').classList.remove('visible');
            storyQuestionAnswered = false;

            if (chapter.question) {
                document.getElementById('storyContinue').textContent = 'ANSWER QUESTION ‚ñ∫';
            } else {
                document.getElementById('storyContinue').textContent = 'CONTINUE ‚ñ∫';
            }
        }

        function continueStory() {
            playSound('click');
            const chapter = currentStoryData.chapters[currentStoryChapter];

            if (chapter.question && !storyQuestionAnswered) {
                // Show question
                document.getElementById('storyQuestionSection').style.display = 'block';
                document.getElementById('storyContinue').style.display = 'none';
                document.getElementById('storyQuestion').textContent = chapter.question.text;

                const choicesDiv = document.getElementById('storyChoices');
                choicesDiv.innerHTML = '';
                chapter.question.choices.forEach((choice, index) => {
                    const btn = document.createElement('button');
                    btn.className = 'reading-choice';
                    btn.textContent = choice;
                    btn.onclick = () => checkStoryAnswer(btn, index, chapter.question.answer);
                    choicesDiv.appendChild(btn);
                });
                document.getElementById('storySpeech').textContent = 'Answer the question about the story!';
            } else {
                // Move to next chapter or finish
                if (currentStoryChapter < currentStoryData.chapters.length - 1) {
                    currentStoryChapter++;
                    loadStoryChapter();
                } else {
                    // Story complete
                    missionStats.story++;
                    const reward = activePowerup === 'double_energon' ? 60 : 30;
                    showCelebration(currentStoryData.bot, `What a great story, Steven! You read the whole adventure!`, currentStoryData.botName, reward);
                    totalEnergonEarned += reward;
                    checkBadges();
                    saveGameState();
                    setTimeout(goBack, 3500);
                }
            }
        }

        function checkStoryAnswer(btn, index, correctAnswer) {
            const buttons = document.querySelectorAll('#storyChoices .reading-choice');
            if (index === correctAnswer) {
                playSound('correct');
                btn.classList.add('correct');
                storyQuestionAnswered = true;
                updateScore(15);
                totalEnergonEarned += 15;
                document.getElementById('storySpeech').textContent = "That's right! Great reading, Steven!";
                buttons.forEach(b => b.style.pointerEvents = 'none');

                // Show next button
                if (currentStoryChapter < currentStoryData.chapters.length - 1) {
                    document.getElementById('storyNext').classList.add('visible');
                } else {
                    setTimeout(continueStory, 1500);
                }
            } else {
                playSound('wrong');
                btn.classList.add('wrong');
                document.getElementById('storySpeech').textContent = "Try again! Think about what happened in the story.";
            }
        }

        function nextStoryChapter() {
            playSound('click');
            currentStoryChapter++;
            loadStoryChapter();
        }

        // Initialize
        createEnergonParticles();
        loadGameState();
        renderShop();
    </script>
</body>
</html>
